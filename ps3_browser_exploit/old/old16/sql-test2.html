



<script>

if (!localStorage.checkins) localStorage.checkins = JSON.stringify([]);

this.db = openDatabase('geomood', '1.0', 'Geo-Mood Checkins', 8192);
this.db.transaction(function(tx) {
  tx.executeSql("create table if not exists " +
    "checkins(id integer primary key asc, time integer, latitude float," +
              "longitude float, mood string)",
    [],
    function() { console.log("siucc"); }
  );
});

var db;
var version = 1;

window.indexedStore = {};

window.indexedStore.setup = function(handler) {
  // attempt to open the database
  var request = indexedDB.open("geomood", version);

  // upgrade/create the database if needed
  request.onupgradeneeded = function(event) {
    var db = request.result;
    if (event.oldVersion < 1) {
      // Version 1 is the first version of the database.
      var checkinsStore = db.createObjectStore("checkins", { keyPath: "time" });
      checkinsStore.createIndex("moodIndex", "mood", { unique: false });
    }
    if (event.oldVersion < 2) {
      // In future versions we'd upgrade our database here.
      // This will never run here, because we're version 1.
    }
    db = request.result;
  };

  request.onsuccess = function(ev) {
    // assign the database for access outside
    db = request.result;
    handler();
    db.onerror = function(ev) {
      console.log("db error", arguments);
    };
  };
};

setup: function(handler) {
  requestFileSystem(
    window.PERSISTENT,
    1024*1024,
    function(fs) {
      fs.root.getDirectory(
        "checkins",
        {}, // no "create" option, so this is a read op
        function(dir) {
          checkinsDir = dir;
          handler();
        },
        function() {
          fs.root.getDirectory(
            "checkins",
            {create: true},
            function(dir) {
              checkinsDir = dir;
              handler();
            },
            onError
          );
        }
      );
    },
    function(e) {
      console.log("error "+e.code+"initialising - see http://goo.gl/YW0TI");
    }
  );
}

var checkins = JSON.parse(localStorage["checkins"]);
checkins.push(checkin);
localStorage["checkins"] = JSON.stringify(checkins);

this.db.transaction(function(tx) {
  tx.executeSql(
    "insert into checkins " +
    "(time, latitude, longitude, mood) values (?,?,?,?);",
    [checkin.time, checkin.latitude, checkin.longitude, checkin.mood],
    handler,
    store.onError
  );
});

var transaction = db.transaction("checkins", 'readwrite');
transaction.objectStore("checkins").put(checkin);
transaction.oncomplete = handler;

fs.root.getFile("checkins/" + checkin.time, {create: true, exclusive: true}, function(file) {
  file.createWriter(function(writer) {
    writer.onerror = fileStore.onError;
    var bb = new WebKitBlobBuilder;
    bb.append(JSON.stringify(checkin));
    writer.write(bb.getBlob("text/plain"));
    handler();
  }, fileStore.onError);
}, fileStore.onError);

var allCheckins = JSON.parse(localStorage["checkins"]);
var matchingCheckins = [];
allCheckins.forEach(function(checkin) {
  if (checkin.mood == moodQuery) {
    matchingCheckins.push(clone(checkin));
  }
});
handler(matchingCheckins);

var matchingCheckins = [];
this.db.transaction(function(tx) {
  tx.executeSql(
    "select * from checkins where mood=?",
    [moodQuery],
    function(tx, results) {
      for (var i = 0; i < results.rows.length; i++) {
        matchingCheckins.push(clone(results.rows.item(i)));
      }
      handler(matchingCheckins);
    },
    store.onError
  );
});

var store = db.transaction("checkins", 'readonly').objectStore("checkins");
var request = moodQuery ?
  store.index("moodIndex").openCursor(new IDBKeyRange.only(moodQuery)) :
  store.openCursor();

request.onsuccess = function(ev) {
  var cursor = request.result;
  if (cursor) {
    handler(cursor.value);
    cursor["continue"]();
  }
};

checkinsDir.createReader().readEntries(function(files) {
  var reader, fileCount=0, checkins=[];
  var readNextFile = function() {
    reader = new FileReader();
    if (fileCount == files.length) return;
    reader.onload = function(e) {
      var checkin = JSON.parse(this.result);
      if (moodQuery==checkin.mood||!moodQuery) handler(checkin);
      readNextFile();
    };
    files[fileCount++].file(function(file) { reader.readAsText(file); });
  };
  readNextFile();
});


handler(JSON.parse(localStorage["checkins"]).length);

store.db.transaction(function(tx) {
  tx.executeSql(
    "select count(*) from checkins;",
    [],
    function(tx, results) {
      handler(results.rows.item(0)["count(*)"]);
    },
    store.onError
  );
  
var count = 0;
var request = db.transaction(["checkins"], 'readonly').objectStore("checkins").openCursor();
request.onsuccess = function(ev) {
  var cursor = request.result;
  cursor ? ++count && cursor["continue"]() : handler(count);
};

checkinsDir.createReader().readEntries(function(files) {
  handler(files.length);
});


</script>





